!function(e){"use strict";!function(){NelioContent.models.Model=Backbone.Model.extend({clearToDefaults:function(){var e={silent:!0};return this.clear(e),"function"==typeof this.defaults?this.set(this.defaults(),e):this.set(this.defaults,e),this},sync:function(e,t,n){return n=n||{},n.beforeSend=function(e){e.setRequestHeader("Authorization","Bearer "+NelioContent.apiAuthToken)},Backbone.Model.prototype.sync.apply(this,arguments)}}),NelioContent.collections.Collection=Backbone.Collection.extend({sync:function(e,t,n){return n=n||{},n.beforeSend=function(e){e.setRequestHeader("Authorization","Bearer "+NelioContent.apiAuthToken)},Backbone.Collection.prototype.sync.apply(this,arguments)}}),NelioContent.helpers.getTemplate=function(e){var t=document.getElementById(e);return t?NelioContent.helpers.template(t.innerHTML):(console.warn("Template «"+e+"» not found. Using empty template."),NelioContent.helpers.template(""))},NelioContent.helpers.template=function(e){return _.template(NelioContent.helpers.trim(e),{evaluate:/\[\*([\s\S]+?)\*\]/g,interpolate:/\[\*=([\s\S]+?)\*\]/g,escape:/\[\*~([\s\S]+?)\*\]/g})}}(),function(e){var t=-1;NelioContent.helpers.refreshAuthToken=function(t,n){e.ajax({url:ajaxurl,data:{action:"nelio_content_get_api_auth_token"},success:function(e){NelioContent.apiAuthToken=e,"function"==typeof t&&t()},error:function(e){"function"==typeof n&&n(e)}})},NelioContent.helpers.isSubscribed=function(){return"none"!==NelioContent.subscription},NelioContent.helpers.getWindowWidth=function(){return e(window).width()},NelioContent.helpers.getScrollbarWidth=function(){if(t>=0)return t;var e=document.createElement("div");e.style.visibility="hidden",e.style.width="100px",e.style.msOverflowStyle="scrollbar",document.body.appendChild(e);var n=e.offsetWidth;e.style.overflow="scroll";var i=document.createElement("div");i.style.width="100%",e.appendChild(i);var o=i.offsetWidth;return e.parentNode.removeChild(e),t=n-o},NelioContent.helpers.openPopup=function(e,t,n){var i="undefined"!=typeof window.screenLeft?window.screenLeft:screen.left,o="undefined"!=typeof window.screenTop?window.screenTop:screen.top,s=window.innerWidth?window.innerWidth:document.documentElement.clientWidth?document.documentElement.clientWidth:screen.width,a=window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:screen.height,r=s/2-t/2+i,l=a/2-n/2+o,c=window.open(e,"","width="+t+", height="+n+", top="+l+", left="+r);return window.focus&&c.focus(),c},NelioContent.helpers.addStyle=function(e){var t=document.head||document.getElementsByTagName("head")[0],n=document.createElement("style");n.type="text/css",n.styleSheet?n.styleSheet.cssText=e:n.appendChild(document.createTextNode(e)),t.appendChild(n)},NelioContent.helpers.callAndDebounce=function(e,t,n){"number"!=typeof n&&(n=0);var i=!1,o=function(){e(),i=!0};0===n?o():setTimeout(o,n);var s=_.debounce(e,t),a=function(){i&&s()};return a},NelioContent.helpers.getParamFromUrl=function(e,t){arguments.length<2&&(t=e,e=window.location.href);var n=e.split("?"),i=n[1]||"";i=i.split("&");for(var o=0;o<i.length;++o){var s=i[o];if(s===t)return"";if(0===s.indexOf(t+"="))return s.replace(t+"=","")}},NelioContent.helpers.addParamInUrl=function(e,t,n){var i=!1;arguments.length<3&&(n=t,t=e,e=window.location.href,i=!0);var o=e.split("?");e=o[0];var s=o[1]||"";s=s.split("&");var a;for(a=0;a<s.length;++a){var r=s[a];if(r===t||0===r.indexOf(t+"="))break}return"undefined"==typeof n?s[a]=t:s[a]=t+"="+encodeURIComponent(n),s.length>0&&(e+="?"+s.join("&")),i&&"function"==typeof history.replaceState&&history.replaceState(null,null,e),e},NelioContent.helpers.removeParamFromUrl=function(e,t){var n=!1;arguments.length<2&&(t=e,e=window.location.href,n=!0);var i=t;"string"==typeof i&&(i=[t]);var o=e.split("?");e=o[0];var s=o[1]||"";s=s.split("&");for(var a=0;a<s.length;++a)for(var r=s[a],l=0;l<i.length;++l)t=i[l],r!==t&&0!==r.indexOf(t+"=")||(s[a]=void 0);return s.length>0&&(e+="?"+s.join("&").replace(/&+/g,"&").replace(/^&|&$/g,"")),n&&"function"==typeof history.replaceState&&history.replaceState(null,null,e),e},NelioContent.helpers.getSelection=function(e){if("undefined"!=typeof document.selection){e.focus();var t=document.selection.createRange();return t.text}if(void 0!==e.selectionStart){var n=e.selectionStart,i=e.selectionEnd;return e.value.substring(n,i)}return""},NelioContent.helpers.getAbsoluteUrl=function(e){return/^\/\//.test(e)?"http:"+e:"/"===e[0]?NelioContent.blogUrl.replace(/^((https?:)?\/\/[^\/]+).*$/,"$1")+e:e}}(jQuery),function(){function e(t){if("BR"===t.tagName)return"\n";var n=[].slice.call(t.childNodes);if(!n.length){var i=t.textContent||t.innerText||"";return"PRE"!==t.tagName&&(i=i.replace(/\r?\n/g,"")),i}return n.reverse(),_.reduce(n,function(t,n){var i=e(n);switch(n.tagName){case"OL":case"P":case"UL":/^\n/.test(t)||(t="\n\n"+t),/^\n\n/.test(t)||(t="\n"+t);break;case"ARTICLE":case"ASIDE":case"BLOCKQUOTE":case"DIV":case"H1":case"H2":case"H3":case"H4":case"H5":case"LI":case"P":/^\n/.test(t)||(t="\n"+t)}return i+t},"")}NelioContent.helpers.trim=function(e){return"string"!=typeof e?e:e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")},NelioContent.helpers.capitalizeFirstLetter=function(e){return"string"!=typeof e?"":e.charAt(0).toUpperCase()+e.slice(1)},NelioContent.helpers.strongify=function(e,t){t=t.replace("\\",""),t=t.replace(".","\\.");var n=new RegExp(t,"gi");return e.replace(n,"<strong>$&</strong>")},NelioContent.helpers.getTweetLength=function(e){return e=e.replace(/[\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff\uff66-\uff9f]/g,"aa"),twttr.txt.getTweetLength(e)};var t=document.createElement("div");NelioContent.helpers.decodeHTMLEntities=function(e){return"string"!=typeof e?"":(e=e.replace(/<script[^>]*>([\S\s]*?)<\/script>/gim,""),e=e.replace(/<\/?\w(?:[^"'>]|"[^"]*"|'[^']*')*>/gim,""),t.innerHTML=e,e=t.textContent,NelioContent.helpers.trim(e))},NelioContent.helpers.extractFirstLetter=function(e){var t=latinize(e.toLowerCase()).replace(/[^a-z]/g,"");return t.length>0?t.substring(0,1):"unknown"};var n=/^(([^<>()\[\]\.,;:\s@\"]+(\.[^<>()\[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i;NelioContent.helpers.isEmail=function(e){return n.test(e)},NelioContent.helpers.processHtml=function(t){function n(e){for(var t=0;t<e.length&&e[t];){var n=e[t];n.parentNode?n.parentNode.removeChild(n):++t}}var i=document.createElement("div");i.innerHTML=t;var o=NelioContent.helpers.extractShareBlockIds(i.getElementsByTagName("ncshare")),s=_.map(o,function(e){var t=i.querySelectorAll("ncshare."+e),n=_.reduce(t,function(e,t){return e+(t.textContent||t.innerText)},""),o=_.reduce(t,function(e,t){return e+t.innerHTML},"");return{text:NelioContent.helpers.trim(n),html:NelioContent.helpers.trim(o)}});return n(i.getElementsByTagName("script")),n(i.getElementsByTagName("link")),n(i.getElementsByTagName("figcaption")),n(i.getElementsByTagName("caption")),n(i.getElementsByTagName("img")),n(i.getElementsByTagName("pre")),n(i.querySelectorAll("li li")),n(_.filter(i.getElementsByTagName("code"),function(e){if(!e.parentNode)return!1;var t=NelioContent.helpers.trim(e.textContent||e.innerText),n=NelioContent.helpers.trim(e.parentNode.textContent||e.parentNode.innerText);return t===n})),_.each(i.getElementsByTagName("a"),function(e){e.textContent='<a href="'+e.getAttribute("href")+'">'+e.textContent+"</a>"}),{clean:e(i),highlights:_.uniq(s),top:_.union(_.map(i.getElementsByTagName("h1"),function(e){return e.textContent||e.innerText}),_.map(i.getElementsByTagName("h2"),function(e){return e.textContent||e.innerText}),_.map(i.getElementsByTagName("h3"),function(e){return e.textContent||e.innerText}),_.map(i.getElementsByTagName("strong"),function(e){return e.textContent||e.innerText}))}},NelioContent.helpers.htmlToText=function(t){var n=document.createElement("div");n.innerHTML=t;try{return e(n).replace(/\n\+$/,"")}catch(i){return n.textContent||n.innerText}}}(),NelioContent.models.ExternalImage=Backbone.Model.extend({defaults:{id:"",source:"",description:"",author:"",authorUrl:"",html:"",urls:!1,selected:!1},initialize:function(){this.listenTo(this,"change:description",this._maybeAppendFullStop),this.listenTo(this,"change:thumbnails",this._stringifySize),this._maybeAppendFullStop(),this._stringifySize()},toggleSelection:function(){var e=this.get("selected");this.set("selected",!e)},_maybeAppendFullStop:function(){var e=this.get("description")||"";e.length?/\.$/.test(e)?this.set("descriptionWithDot",e):/…$/.test(e)?this.set("descriptionWithDot",e):this.set("descriptionWithDot",e+"."):this.set("descriptionWithDot",e)},_stringifySize:function(){var e=this.get("thumbnails").original||{},t=e.size,n="",i=["Bytes","KB","MB","GB","TB"];if(t){var o=parseInt(Math.floor(Math.log(t)/Math.log(1024)));n=Math.round(t/Math.pow(1024,o),2)+" "+i[o]}this.set("size",n)}}),NelioContent.collections.ExternalImages=NelioContent.collections.Collection.extend({model:NelioContent.models.ExternalImage,initialize:function(){this.listenTo(this,"add",this._onAdd),this.listenTo(this,"remove",this._onRemove),this.listenTo(this,"reset",this._onReset)},_onAdd:function(e){this.listenTo(e,"change:selected",this._guaranteeUniqueSelection),this.listenTo(e,"change:selected",this._triggerNewSelection),this.listenTo(e,"destroy",this.remove)},_guaranteeUniqueSelection:function(e){e.get("selected")&&this.each(function(t){t!==e&&t.get("selected")&&t.set("selected",!1)})},_triggerNewSelection:function(e){e.get("selected")?this.trigger("nc:change:selection",e):this.trigger("nc:change:selection")},_onRemove:function(e){this.stopListening(e)},_onReset:function(e,t){_.each(t.previousModels,this._onRemove,this),this.each(this._onAdd,this)}}),NelioContent.views.ExternalImage=Backbone.View.extend({_isLocked:!1,template:NelioContent.helpers.getTemplate("_nc-external-image"),tagName:"li",className:"nc-external-image",events:{click:"_toggleSelection"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.model,"change:selected",this.render)},render:function(){var e=this.model.toJSON();return this.el.innerHTML=this.template(e),this.model.get("selected")?this.el.className="nc-external-image details selected":this.el.className="nc-external-image",this},_toggleSelection:function(){this._isLocked||this.model.toggleSelection()},lock:function(){this._isLocked||(this._isLocked=!0)},unlock:function(){this._isLocked&&(this._isLocked=!1)},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.ExternalImages=Backbone.View.extend({_imageViews:[],_isLocked:!1,_rendered:!1,_source:!1,_postId:!1,_query:void 0,template:NelioContent.helpers.getTemplate("_nc-external-images"),detailsTemplate:NelioContent.helpers.getTemplate("_nc-external-image-details"),events:{"change #nc-search-field":"_onSearchChange","keyup #nc-search-field":"_onSearchChange","change .link-to":"_onLinkToChange","click .nc-insert-button":"_onImageSelected"},initialize:function(e){this._source=e.source,this._postId=e.postId,this._query={value:!1,ajax:!1},"undefined"==typeof this.collection&&(this.collection=new NelioContent.collections.ExternalImages),this.collection.each(function(e){var t=new NelioContent.views.ExternalImage({model:e});this._imageViews.push(t)},this),this.render=_.bind(this.render,this),this._onSearchChange=_.bind(this._onSearchChange,this),this._search=_.debounce(this._search,800),this.listenTo(this.collection,"reset",this._resetImageViews),this.listenTo(this.collection,"reset",this.render),this.listenTo(this.collection,"nc:change:selection",this._onSelectionChange)},render:function(){this._rendered||(this.el.innerHTML=this.template(),this._rendered=!0);var e=this.$(".nc-external-images");return e.children().detach(),_.each(this._imageViews,function(t){e.append(t.render().el)},this),this},_onSelectionChange:function(e){if(!this._isLocked)if(e){var t=e.toJSON();this.$(".nc-image-details-panel").html(this.detailsTemplate(t)),this.$(".nc-insert-button").prop("disabled",!1),this._maybeFixSizeSelectors(t)}else this.$(".nc-insert-button").prop("disabled",!0),this.$(".nc-image-details-panel").empty()},_maybeFixSizeSelectors:function(t){this.$(".size option[data-width]").each(function(){var n=e(this);n.data("width")>t.thumbnails.original.width&&n.hide()}),this.$(".size option[data-height]").each(function(){var n=e(this);n.data("height")>t.thumbnails.original.height&&n.hide()})},_onLinkToChange:function(){if(!this._isLocked){var e=this.$(".link-to").val(),t=this.$(".link-to-custom"),n=this.collection.findWhere({selected:!0}),i="";switch(n&&(i=n.get("url")),e){case"file":t.prop("readonly",!0),t.val(i),i?t.removeClass("hidden"):t.addClass("hidden");break;case"custom":t.prop("readonly",!1),t.val("http://"),t.removeClass("hidden");break;default:t.addClass("hidden")}}},_onImageSelected:function(){if(!this._isLocked){var e=this.collection.findWhere({selected:!0}),t=this._getImageData(e);this._maybeUploadImageToMediaLibrary(t,_.bind(function(e){this.trigger("nc:select:image",e)},this))}},_maybeUploadImageToMediaLibrary:function(t,n){if("pixabay"!==this._source)return n(t);var i=this,o=this.$(".nc-insert-button").html();this._lock(),this.$(".nc-insert-button").html(NelioContent.i18n.feedback.uploading),e.ajax({url:ajaxurl,data:{action:"nelio_content_upload_attachment",file:t.src,postId:this._postId,desc:t.caption,thumbnail:t.size},success:function(e){t.src=e.url,t.id=e.id,n(t)},error:function(e,t,n){console.log(n)},complete:function(){i.$(".nc-insert-button").html(o),i._unlock()}})},_getImageData:function(e){var t={caption:this.$('[data-setting="caption"] textarea').val()||"",alt:this.$('[data-setting="alt"] input').val()||"",align:this.$(".alignment option:selected").val()||"none",size:this.$(".size option:selected").val()||"large"};if("pixabay"===this._source){if("full"===t.size)t.width=e.get("thumbnails").original.width,t.height=e.get("thumbnails").original.height;else{var n=this.$(".size option:selected");t.width=n.data("width"),t.height=n.data("height")}t.src=e.get("thumbnails").original.image}else t.size=this.$(".size option:selected").val()||"medium",t.width=e.get("thumbnails")[t.size].width,t.height=e.get("thumbnails")[t.size].height,t.src=e.get("thumbnails")[t.size].image;t.link="none";var i=this.$(".link-to option:selected").val()||"none";return"none"!==i&&(t.link=this.$('[data-setting="linkUrl"]').val()||"none"),t},_onSearchChange:function(){this._isLocked||this._search()},_search:function(){var t,n,i=this.$("#nc-search-field").val(),o=this._source;if(i!==this._query.value){if(this._query.value=i,this._query.ajax&&this._query.ajax.abort(),t="nc-"+o+"-image-search["+i+"]",n=ncstore.get(t),n&&n.length)return this.collection.reset(n);this.$(".spinner").css("visibility","visible"),this.$(".nc-no-images-found").hide(),this.$(".nc-insert-button").prop("disabled",!0),this.$(".nc-image-details-panel").empty(),this._query.ajax=e.ajax({url:NelioContent.searchApiUri,method:"GET",data:{q:i,src:o},headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},success:_.bind(function(e){0===e.length&&i.length&&this.$(".nc-no-images-found").show(),this.collection.reset(e),ncstore.set(t,e,(new Date).getTime()+828e5)},this),error:_.bind(function(e){this.collection.trigger("nc:error",e.responseJSON)},this),complete:_.bind(function(){this._query.ajax=!1,this.$(".spinner").css("visibility","hidden")},this)})}},_resetImageViews:function(){_.each(this._imageViews,function(e){e.close()},this),this._imageViews=[],this.collection.each(this._addExternalImage,this)},_addExternalImage:function(e){var t=new NelioContent.views.ExternalImage({model:e});this._imageViews.push(t)},_lock:function(){this._isLocked||(this._isLocked=!0,this.$("*").attr("disabled","disabled"),this.$el.addClass("nc-locked"),_.each(this._imageViews,function(e){e.lock()}))},_unlock:function(){this._isLocked&&(this._isLocked=!1,this.$("*").removeAttr("disabled"),this.$el.removeClass("nc-locked"),_.each(this._imageViews,function(e){e.unlock()}))},close:function(){_.each(this._imageViews,function(e){e.close()},this),this._imageViews=[],this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}});var t=new NelioContent.views.ExternalImages({el:document.getElementById("nc_media_container"),source:document.getElementById("nc_current_media_tab").getAttribute("value"),postId:window.parent.jQuery("#post_ID").val()});t.render(),Backbone.listenTo(t,"nc:select:image",function(e){var t,n,i,o=e.id||"";e.width&&(n='width="'+e.width+'"'),e.height&&(i='height="'+e.height+'"'),t='<img class="size-'+e.size+" wp-image-"+o+'" alt="'+e.alt+'" src="'+e.src+'" '+n+" "+i+" />","none"!==e.link&&(t='<a href="'+e.link+'">'+t+"</a>"),e.caption&&e.caption.length&&(t='[caption id="attachment_'+o+'" align="align'+e.align+'" '+n+"]"+t+" "+e.caption+"[/caption]"),parent.tinyMCE&&parent.tinyMCE.activeEditor&&!parent.tinyMCE.activeEditor.isHidden()?parent.tinyMCE.activeEditor.selection.setContent(t):parent.QTags&&parent.QTags.insertContent(t),parent.wp.media.frame.close()})}(jQuery);