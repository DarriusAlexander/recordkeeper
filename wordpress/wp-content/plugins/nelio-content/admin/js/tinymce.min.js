var NCTinyMce=NCTinyMce||{};NCTinyMce.shareButtons={},tinymce.PluginManager.add("nelio_content",function(e){NCTinyMce.addShareButtons(e),NCTinyMce.addShareBlockLengthCount(e),NCTinyMce.listenToEditorEvents(e)}),NCTinyMce.addShareButtons=function(e){e.addButton("nelio_content",{title:NelioContent.i18n.titles.socialAutomations,type:"menubutton",icon:"nc-share-selection",disabled:!1,onclick:function(){NCTinyMce.fixShareButtons(e)},menu:[NCTinyMce.addButtonForCreatingSocialMessage(e),NCTinyMce.addButtonForCreatingShareBlock(e),NCTinyMce.addButtonForRemovingShareBlocks(e)]})},NCTinyMce.addShareBlockLengthCount=function(e){e.on("init",function(){var n=e.theme.panel&&e.theme.panel.find("#statusbar")[0];n&&n.insert({type:"label",name:"ncsharelength",text:"",classes:"ncshare-length",disabled:e.settings.readonly},0)})},NCTinyMce.addButtonForCreatingSocialMessage=function(e){return{text:NelioContent.i18n.actions.createSocialMessage,disabled:!0,onclick:function(){var n=e.selection.getContent({format:"html"}),t=e.selection.getContent({format:"text"});NCTinyMce.createSocialMessage(t,n)},onPostRender:function(){NCTinyMce.initButton(e,"createSocialMessage",this)}}},NCTinyMce.addButtonForCreatingShareBlock=function(e){return{text:NelioContent.i18n.actions.addShareBlock,disabled:!1,onclick:function(){NCTinyMce.addShareBlock(e)},onPostRender:function(){NCTinyMce.initButton(e,"addShareBlock",this)}}},NCTinyMce.addButtonForRemovingShareBlocks=function(e){return{text:NelioContent.i18n.actions.removeShareBlock,disabled:!1,onclick:function(){NCTinyMce.removeShareBlocks(e)},onPostRender:function(){NCTinyMce.initButton(e,"removeShareBlock",this)}}},NCTinyMce.listenToEditorEvents=function(e){e.on("Change NodeChange KeyUp",_.debounce(function(){NCTinyMce.removeHighlightFromShareBlocks(e),NCTinyMce.maybeHighlightShareBlock(e),NCTinyMce.maybeShowShareBlockLengthCount(e)},100)),e.on("Blur",_.debounce(function(){NCTinyMce.removeHighlightFromShareBlocks(e)}),100),e.on("PastePreProcess",function(){NCTinyMce.changeShareBlockIdsOnPaste(e)})},NCTinyMce.createSocialMessage=function(e,n){if(e=NelioContent.helpers.trim(e),0!==e.length){var t=new NelioContent.models.SocialMessage;t.setPost(NCTinyMce.timelineView.collection.post),t.set("profileId",NelioContent.profiles.at(0).get("id"));var o=NCTinyMce.searchTwitterHandleToMention(n);if(o){var i=o.get("twitter").replace("@","");e=e+" /cc @[twitter:"+i+"]",t.set("mentions",[{network:"twitter",kind:"single",displayName:o.get("author")||"@"+i,displayMentionEscaped:_.escape("@"+i),username:i,link:"https://twitter.com/"+i}])}t.set("text",e+" {permalink}");var c=new NelioContent.views.SocialMessageEditor({model:t});c.disableProfiles(NCTinyMce.timelineView.collection.getDisabledProfileIds()),Backbone.listenToOnce(c,"nc:add:messages",function(e){NCTinyMce.timelineView.collection.add(e)}),c.render()}},NCTinyMce.searchTwitterHandleToMention=function(e){if(!_.contains(NelioContent.profiles.pluck("network"),"twitter"))return!1;for(var n=NelioContent.helpers.extractReferences(e),t=0;t<n.length;++t){var o,i=n[t];if(o=NCTinyMce.suggestedReferences.get(i),o&&o.get("twitter"))return o;if(o=NCTinyMce.externalReferences.get(i),o&&o.get("twitter"))return o}return!1},NCTinyMce.initButton=function(e,n,t){"undefined"==typeof NCTinyMce.shareButtons[e.id]&&(NCTinyMce.shareButtons[e.id]={}),NCTinyMce.shareButtons[e.id][n]=t,NCTinyMce.fixShareButtons(e)},NCTinyMce.fixShareButtons=function(e){var n=e.selection.getContent({format:"text"}),t=0<NelioContent.helpers.trim(n.length),o=NCTinyMce.shareButtons[e.id];if(o.createSocialMessage&&o.createSocialMessage.disabled(!t),o.addShareBlock&&o.addShareBlock.disabled(!t),o.removeShareBlock){var i=0<NCTinyMce.getSelectedShareBlocks(e).length;o.removeShareBlock.disabled(!i)}},NCTinyMce.addShareBlock=function(e){var n=NelioContent.helpers.generateUniqueId();e.formatter.register("ncshare",{inline:"ncshare",classes:n}),e.formatter.apply("ncshare"),e.formatter.unregister("ncshare"),e.selection.collapse()},NCTinyMce.removeShareBlocks=function(e){var n=NCTinyMce.getSelectedShareBlocks(e);if(n.length){var t=e.selection.getContent({format:"text"});0===t.length&&(n=[n[0]]),n=_.map(n,function(e){return"ncshare."+e});var o=e.dom.select(n.join(","));e.dom.remove(o,!0),e.selection.collapse()}},NCTinyMce.getSelectedShareBlocks=function(e){var n=document.createElement("div");n.innerHTML=e.selection.getContent();var t=_.union(_.map(n.querySelectorAll("ncshare")),NCTinyMce.findAncestorShareBlocks(e.selection.getNode()));return NelioContent.helpers.extractShareBlockIds(t)},NCTinyMce.findAncestorShareBlocks=function(e){for(var n=[];e;)"ncshare"===e.nodeName.toLowerCase()&&n.push(e),e=e.parentNode;return n},NCTinyMce.maybeHighlightShareBlock=function(e){var n=e.selection.getContent({format:"text"});if(!(0<n.length)){var t=NCTinyMce.getSelectedShareBlocks(e);if(t=_.map(t,function(e){return"ncshare."+e}),t.length){var o=e.dom.select(t[0]);o.forEach(function(e){e.className+=" nc-has-caret nc-first"});for(var i=1;i<t.length;++i){var c=e.dom.select(t[i]);c.forEach(function(e){e.className+=" nc-has-caret"})}}}},NCTinyMce.removeHighlightFromShareBlocks=function(e){e.dom.select("ncshare.nc-has-caret").forEach(function(e){var n=e.className;n=n.replace(/nc-has-caret/g,""),n=n.replace(/nc-first/g,""),e.className=NelioContent.helpers.trim(n)})},NCTinyMce.changeShareBlockIdsOnPaste=function(e){var n=document.createElement("div");n.innerHTML=e.content;var t=_.map(n.querySelectorAll("ncshare")),o=NelioContent.helpers.extractShareBlockIds(t),i=_.map(o,function(){return NelioContent.helpers.generateUniqueId()});t.forEach(function(e){for(var n=e.className,t=0;t<o.length;++t)n=n.replace(o[t],i[t]);e.className=n}),e.content=n.innerHTML},NCTinyMce.maybeShowShareBlockLengthCount=function(e){var n=e.theme.panel.find("#ncsharelength");if(n){var t=e.selection.getContent({format:"text"});if(t.length)return n.text([NelioContent.i18n.feedback.selectionLength,t.length]),void n.show();var o=NCTinyMce.getSelectedShareBlocks(e);if(o.length){var i=e.dom.select("ncshare."+o[0]),c=_.reduce(i,function(e,n){return e+=n.textContent||n.innerText},"");return c+=" https://example.com",n.text([NelioContent.i18n.feedback.shareBlockLength,NelioContent.helpers.getTweetLength(c)]),void n.show()}n.hide()}};