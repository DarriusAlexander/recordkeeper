!function(e){"use strict";NelioContent.views.SocialMessageEditor=Backbone.View.extend({_rendered:!1,_views:{actualEditor:void 0,profileSelector:void 0,dateSelector:void 0,timeSelector:void 0,preview:void 0},_isPreviewVisible:!0,_$window:void 0,_$saveButton:void 0,_closeAndDestroy:!0,template:NelioContent.helpers.getTemplate("_nc-social-message-editor"),initialize:function(){this._$window=e(window),this.render=_.bind(this.render,this),this._onDialogSave=_.bind(this._onDialogSave,this),this._onDialogCancel=_.bind(this._onDialogCancel,this),this._onDialogDelete=_.bind(this._onDialogDelete,this),this._views.actualEditor=new NelioContent.views.SocialMessageActualEditor({model:this.model}),this.listenTo(this._views.actualEditor,"nc:click:preview",this._togglePreviewVisibility),this.listenTo(this._views.actualEditor,"nc:click:addImage",this._addImage),this.listenTo(this._views.actualEditor,"nc:click:useOldMessage",this._useOldMessage),this._views.actualEditor.isPreviewVisible(this._isPreviewVisible),this._views.dateSelector=new NelioContent.views.DateSelector({model:this.model}),this._views.timeSelector=new NelioContent.views.TimeSelector({model:this.model}),this.model.isNew()?NelioContent.profiles.length>1?this._views.profileSelector=new NelioContent.views.MultipleProfileSelector({model:this.model}):NelioContent.profiles.at(0).allowsMultiTargets()?this._views.profileSelector=new NelioContent.views.MultipleProfileSelector({model:this.model}):this._views.profileSelector=new NelioContent.views.SingleProfileSelector({model:this.model}):this._views.profileSelector=new NelioContent.views.SingleProfileSelector({model:this.model}),this._isPreviewVisible="visible"===ncstore.get("nc-preview","visible"),this._isPreviewVisible&&this._selectAppropriatePreviewView(),this._convertToDialog(),this.listenTo(this.model,"change:network",this._selectAppropriatePreviewView),this.listenTo(this.model,"change",this._maybeEnableSaveButton),this.listenTo(this.model,"nc:load:post",this.render),this.listenTo(this.model,"nc:error:post",this._unableToLoadPost)},render:function(){if(this.model.get("postId")>0&&0===this.model.post.get("id")){this.model.loadPost(),this.el.innerHTML='<div class="nc-social-message-editor"><div class="nc-loading-container"><span class="spinner is-active"></span><div class="nc-loading">'+NelioContent.i18n.feedback.loadingNoSpinner+"</div></div></div>";var e=this.$el.parent().find("button.nc-save-button");return e.addClass("button-disabled"),this}if(this._rendered)return this;this._rendered=!0;var t=this.model.toJSON();return this.el.innerHTML=this.template(t),this.$(".nc-editor").html(this._views.actualEditor.render().$el),"undefined"!=typeof this._views.profileSelector&&this.$(".nc-profile-selector").html(this._views.profileSelector.render().$el),this.$(".nc-date").html(this._views.dateSelector.render().$el),this.$(".nc-time").html(this._views.timeSelector.render().$el),NelioContent.helpers.isSubscribed()||(this._views.dateSelector.lock(),this._views.timeSelector.lock()),this.model.isNew()?NelioContent.profiles.length>1?this.$(".nc-profile-selector").addClass("nc-multiple"):NelioContent.profiles.at(0).allowsMultiTargets()?this.$(".nc-profile-selector").addClass("nc-multiple"):(this.$(".nc-profile-selector").addClass("nc-single"),this.$(".nc-profile-selector").addClass("nc-profile-hidden")):1!==NelioContent.profiles.length&&NelioContent.helpers.isSubscribed()?this.$(".nc-profile-selector").addClass("nc-single"):(this.$(".nc-profile-selector").addClass("nc-single"),this.$(".nc-profile-selector").addClass("nc-profile-hidden")),this._isPreviewVisible&&this._addPreview(),this._maybeEnableSaveButton(),this},disableProfiles:function(e){"function"==typeof this._views.profileSelector.disableProfiles&&this._views.profileSelector.disableProfiles(e)},_lock:function(){this.$el.addClass("nc-locked"),this._views.actualEditor.lock(),this._views.profileSelector.lock(),this._views.dateSelector.lock(),this._views.timeSelector.lock()},_selectAppropriatePreviewView:function(){if(this._isPreviewVisible){var e=NelioContent.profiles.get(this.model.get("profileId"));"undefined"==typeof e&&(e=NelioContent.profiles.at(0),this.model.set("profileId",e.get("id")));var t=_.findWhere(NelioContent.networkMetas,{id:e.get("network")});"undefined"==typeof t&&(t=NelioContent.networkMetas[0]);var i=NelioContent.views[t.previewClassName];this._removePreview(),this._views.preview=new i({model:this.model}),this._addPreview()}},_addPreview:function(){this.$(".nc-social-preview").html(this._views.preview.render().$el)},_removePreview:function(){"object"==typeof this._views.preview&&(this._views.preview.close(),this._views.preview=!1)},_togglePreviewVisibility:function(){this._isPreviewVisible=!this._isPreviewVisible,this._isPreviewVisible?ncstore.set("nc-preview","visible"):ncstore.set("nc-preview","hidden"),this._views.actualEditor.isPreviewVisible(this._isPreviewVisible),this._views.actualEditor.render(),this._isPreviewVisible?(this._selectAppropriatePreviewView(),this._addPreview()):this._removePreview()},_convertToDialog:function(){var e=[];e.push(NelioContent.helpers.makeDialogCancelButton(this,NelioContent.i18n.actions.cancel)),e.push(NelioContent.helpers.makeDialogSaveButton(this,NelioContent.i18n.actions.save)),this.model.isNew()||e.push(NelioContent.helpers.makeDialogDeleteButton(this,NelioContent.i18n.actions.delLabel));var t=this;this.$el.dialogS2({title:t.model.isNew()?NelioContent.i18n.titles.newMessage:NelioContent.i18n.titles.editMessage,buttons:e,draggable:!1,modal:!0,resizable:!1,width:Math.min(600,t._$window.width()-40),dialogClass:"nc-dialog",position:{my:"center top",at:"center top+60"},open:function(){t.listenTo(t,"nc:click:dialog:save",t._onDialogSave),t.listenTo(t,"nc:click:dialog:cancel",t._onDialogCancel),t.listenTo(t,"nc:click:dialog:delete",t._onDialogDelete),t._$saveButton=t.$el.parent().find("button.nc-save-button"),NelioContent.helpers.makeWarningTooltip(t._$saveButton);var e=t.$el.parent().find("button.nc-delete-button");e.length>0&&e.blur()},close:function(){t.stopListening(t,"nc:click:dialog:save",t._onDialogSave),t.stopListening(t,"nc:click:dialog:cancel",t._onDialogCancel),t.stopListening(t,"nc:click:dialog:delete",t._onDialogDelete),t._$saveButton.tooltip("destroy"),t._$saveButton=void 0,t._closeAndDestroy&&(t.$el.dialogS2("destroy"),t.trigger("nc:close:dialog"))}})},_maybeEnableSaveButton:function(){if("undefined"!=typeof this._$saveButton){this._$saveButton.tooltip("close");var e=this.model.isSomethingMissing();e?(this._$saveButton.addClass("button-disabled",!0),this._$saveButton.attr("title",e)):(this._$saveButton.removeClass("button-disabled",!1),this._$saveButton.attr("title",""))}},_addImage:function(){this._closeAndDestroy=!1,this.$el.dialogS2("close");var e;this.model.get("imageId")>0?e=this.model.get("imageId"):this.model.post.get("imageId")>0&&(e=this.model.post.get("imageId"));var t=this;NelioContent.helpers.selectImage({image:e,onSelection:function(e){e=e||{};var i=e.url||"",s=e.id||0;0<s&&0<i.length?(t.model.set("type","image"),t.model.set("image",i),t.model.set("imageId",s)):(t.model.set("type","text"),t.model.set("image",""),t.model.set("imageId",0)),this.onClose()},onClose:function(){setTimeout(function(){t.$el.dialogS2("open"),t._closeAndDestroy=!0,t._maybeEnableSaveButton()},0)}})},_useOldMessage:function(){var t=this,i=e("<div>"+NelioContent.i18n.feedback.loading+"</div>"),s={title:NelioContent.i18n.titles.reusePreviousMessage,modal:!0,width:Math.min(500,e(window).width()-20),dialogClass:"nc-dialog",closeOnEscape:!1,resizable:!1,buttons:[NelioContent.helpers.makeDialogButton(t,"select","OK",!0)],position:{my:"center top",at:"center top+70"}};s.buttons[0]["class"]="button button-primary button-disabled",i.dialog(s),e.ajax({url:NelioContent.apiUri+"/post/"+t.model.post.get("id")+"/items",method:"GET",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},success:function(e){var s=_.map(e.social,function(e){return _.each(e.mentions,function(t){"facebook"===t.network&&(e.textComputed=e.textComputed.replace(new RegExp("@\\["+t.networkId+"\\]","g"),t.displayName))}),e}),n=_.uniq(_.pluck(s,"textComputed"));s=_.map(n,function(e){return _.filter(s,function(t){return t.textComputed===e})[0]}),t._selectOldMessage(s),i.dialog("close")},error:function(){t._selectOldMessage([])}})},_selectOldMessage:function(t){var i=this,s={title:NelioContent.i18n.titles.reusePreviousMessage,modal:!0,width:Math.min(500,e(window).width()-20),closeOnEscape:!1,resizable:!1,buttons:[NelioContent.helpers.makeDialogButton(i,"select",NelioContent.i18n.actions.ok,!0)],position:{my:"center top",at:"center top+70"}};if(t.length){var n="<div>";n+="<p><strong>"+NelioContent.i18n.dialogs.reusePreviousMessage+"</strong></p>",n+='<p><input type="radio" name="message" value="0" checked="checked">'+_.escape(t[0].textComputed)+"</p>";for(var o=1;o<t.length;++o)n+='<p><input type="radio" name="message" value="'+o+'">'+_.escape(t[o].textComputed)+"</p>";n+="</div>";var a=e(n);s.dialogClass="nc-dialog nc-use-old-message",s.buttons[0].click=function(){var e=a.find('input[type="radio"][name="message"]:checked').val(),s=t[e]||{text:"{title} {permalink}",mentions:[]};i.model.set("text",s.text),i.model.set("mentions",s.mentions),i._views.actualEditor.render(),a.dialog("close")},a.dialog(s)}else{var l=e("<div>"+NelioContent.i18n.feedback.noOldMessages+"</div>");s.dialogClass="nc-dialog",s.buttons[0].click=function(){l.dialog("close")},l.dialog(s)}},_onDialogSave:function(){if(!this.model.isSomethingMissing()){var e=this.$el.parent(),t=e.find(".ui-dialog-buttonpane button.button-primary"),i=e.find(".ui-dialog-titlebar button, .ui-dialog-buttonpane button:not( .button-primary )");this._lock(),this.$el.dialogS2("option","closeOnEscape",!1),t.prop("disabled",!0),i.prop("disabled",!0),t.html(NelioContent.i18n.feedback.saving);var s=this;this.model.save(void 0,{success:function(e,t){s.model.isNew()?(t.forEach(function(e){e.source=e.source||void 0}),s.trigger("nc:add:messages",t)):(t.source=t.source||void 0,s.trigger("nc:update:message",t)),s.$el.dialogS2("close")},error:function(e){s.$el.dialogS2("close")}})}},_onDialogCancel:function(){this.$el.dialogS2("close")},_onDialogDelete:function(){var e=this,t=NelioContent.helpers.openDeletionConfirmationDialog(NelioContent.i18n.titles.delSocialMessage,NelioContent.i18n.dialogs.deleteSocialMessage,NelioContent.i18n.actions.doDeleteSocial,function(){var i=t.parent();i.find(".nc-super-delete-button").html(NelioContent.i18n.feedback.deleting),i.find("button").prop("disabled",!0),e.model.destroy({success:function(i,s){t.dialog("destroy"),e.trigger("nc:delete:message",e.model),e.$el.dialogS2("close")}})})},_unableToLoadPost:function(e){this.$el.dialogS2("close"),this.close();var t=NelioContent.i18n.errors.socialMessage.unableToLoadPost;t=t.replace("{error}",e),NelioContent.helpers.openErrorDialog(e)},close:function(){_.each(_.values(this._views),function(e){"object"==typeof e&&"function"==typeof e.close&&e.close()}),this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.SocialMessageActualEditor=Backbone.View.extend({_isLocked:!1,_isPreviewVisible:void 0,_awaitingImageDeletionConfirmation:!1,_relatedPostMode:"hide-related-post",_$postSelectorDiv:void 0,template:NelioContent.helpers.getTemplate("_nc-social-message-actual-editor"),events:{"click .nc-action.nc-preview":"_triggerPreviewEvent","click .nc-action.nc-add.nc-image":"_addImage","click .nc-action.nc-remove.nc-image":"_removeImage","click .nc-do-remove":"_doRemoveImage","click .nc-cancel-remove":"_hideRemoveConfirmation","click .nc-action.nc-use-old-message":"_useOldMessage","click .nc-post-selector a":"_createRelatedPostSelector","change .nc-social-message":"_changeText","keyup  .nc-social-message":"_changeText"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this._searchProfilesToMention=_.bind(_.debounce(this._searchProfilesToMention,500),this),this.listenTo(this.model,"change:text",this.render),this.listenTo(this.model,"change:type",this.render),this.listenTo(this.model,"change:postId",this.render),this.listenTo(this.model,"change:network",this._initAtWhoSearches),this.listenTo(this.model,"change:network",this._updateCharCount),this.listenTo(this.model,"change:profiles",this._updateCharCount),this.listenTo(this.model,"change:network",this._highlightMentions),this.model.isNew()?this.listenTo(this.model,"change:profiles",this._highlightMentions):this.listenTo(this.model,"change:profileId",this._highlightMentions),this.listenTo(this,"nc:use:profile",_.bind(this.model.addNewMention,this.model)),this._awaitingImageDeletionConfirmation=!1,this.model.isNew()?0===this.model.get("postId")&&"undefined"!=typeof NelioContent.lastPublishedPost?this._relatedPostMode="show-post-selector-action":this._relatedPostMode="hide-related-post":0===this.model.get("postId")?this._relatedPostMode="no-related-post":this._relatedPostMode="show-related-post"},render:function(){"undefined"!=typeof this._$postSelectorDiv&&this._$postSelectorDiv.detach();var e=this.model.toJSON();return e.isPreviewVisible=this._isPreviewVisible,e.awaitingDeletionConfirmation=this._awaitingImageDeletionConfirmation,e.relatedPostMode=this._relatedPostMode,e.postEditLink=this.model.post.get("editLink"),e.postTitleFormatted=this.model.post.get("titleFormatted"),e.hasPost=0!==this.model.post.get("id"),this.$(".nc-social-message").atwho("destroy"),this.el.innerHTML=this.template(e),this.$(".nc-social-message")[0].innerHTML=this.model.getEditableHtmlText(),this.$(".nc-social-message")[0].addEventListener("paste",this._clearFormatOnPaste),this.$(".nc-social-message")[0].addEventListener("keydown",function(e){e.stopPropagation()}),this._initAtWhoSearches(),this._highlightMentions(),this._updateCharCount(),"show-post-selector"===this._relatedPostMode&&this.$(".nc-post-selector-container").html(this._$postSelectorDiv),this},isPreviewVisible:function(e){this._isPreviewVisible=e},lock:function(){this._isLocked=!0,this.$("textarea").prop("disabled",!0),this.$(".nc-post-selector a").css("color","grey"),this._$postSelectorDiv&&this._$postSelectorDiv.find("select").attr("disabled","disabled")},_initAtWhoSearches:function(){var e=this.$(".nc-social-message");e.atwho("destroy");var t,i=this.model.get("network");if("twitter"===i)t=NelioContent.i18n.titles.searchMentionOnTwitter;else{if("facebook"!==i)return;t=NelioContent.i18n.titles.searchMentionOnFacebook}var s=NelioContent.helpers.getTemplate("_nc-mention-in-editor")({network:this.model.get("network"),networkId:"${networkId}",username:"${username}",displayMentionEscaped:"${displayMentionEscaped}"});e.atwho({at:"@",acceptSpaceBar:!1,lookUpOnClick:!1,limit:20,maxLen:20,minLen:2,searchKey:"displayMentionEscaped",headerTpl:'<div class="atwho-header">'+t+"</div>",displayTpl:NelioContent.helpers.getTemplate("_nc-mention-search-result")(),insertTpl:s,editorView:this,callbacks:{remoteFilter:this._searchProfilesToMention,filter:null,sorter:null}})},_highlightMentions:function(){var e=!1,t=!1,i=_.map(_.pluck(this.model.get("profiles"),"id"),function(e){var t=NelioContent.profiles.get(e);return t?t.toJSON():{}}),s=this.model.get("network");this.model.isNew()?(e="facebook"===s&&_.where(i,{network:"facebook",kind:"page"}).length,t="twitter"===s&&_.where(i,{network:"twitter"}).length):(e="facebook"===s&&"page"===this.model.get("networkKind"),t="twitter"===s);var n=this.$(".nc-social-message");t?n[0].className="nc-social-message nc-twitter-selected":e?n[0].className="nc-social-message nc-facebook-page-selected":n[0].className="nc-social-message"},_triggerPreviewEvent:function(){this._isLocked||this.trigger("nc:click:preview")},_changeText:function(e){if(!this._isLocked){var t=e.target.cloneNode(!0)||e.srcElement.cloneNode(!0);_.each([].slice.call(t.querySelectorAll(".nc-mention")),function(e){e.innerHTML=e.getAttribute("data-mention")}),this.el.appendChild(t);var i=t.innerText;this.el.removeChild(t),this.stopListening(this.model,"change:text",this.render),this.model.set("text",NelioContent.helpers.trim(i)),this.listenTo(this.model,"change:text",this.render),this._updateCharCount()}},_updateCharCount:function(){if(!this._isLocked){var e=this.$(".nc-message-length"),t=this.$(".nc-char-count"),i=this.$(".nc-circle-arc"),s=this.model.getMaxTextLength()-this.model.getTextLength(),n=Math.min(1,this.model.getTextLength()/this.model.getMaxTextLength());t.text(Math.min(99,Math.abs(s))),i.css("stroke-dashoffset",50.2655*(1-n)),e.removeClass("nc-warning"),e.removeClass("nc-danger"),0>=s?(e.addClass("nc-danger"),i.addClass("nc-pulse")):20>=s?(e.addClass("nc-warning"),i.removeClass("nc-pulse")):i.removeClass("nc-pulse")}},_addImage:function(){this._isLocked||this.trigger("nc:click:addImage")},_useOldMessage:function(){this._isLocked||this.model.post.get("id")&&this.trigger("nc:click:useOldMessage")},_removeImage:function(){this._isLocked||(this._awaitingImageDeletionConfirmation=!0,this.trigger("nc:render"))},_doRemoveImage:function(){this._isLocked||(this.model.set("type","text"),this.model.set("image",""),this.model.set("imageId",0),this._hideRemoveConfirmation())},_hideRemoveConfirmation:function(){this._isLocked||(this._awaitingImageDeletionConfirmation=!1,this.trigger("nc:render"))},_createRelatedPostSelector:function(t){if(t.preventDefault(),!this._isLocked){var i=e("<select></select>");this._$postSelectorDiv=e("<div></div>"),this._$postSelectorDiv.html(i),this.$(".nc-post-selector-container").html(this._$postSelectorDiv);var s=NelioContent.lastPublishedPost.toJSON();s.text=s.titleFormatted;var n=this,o=NelioContent.helpers.getTemplate("_nc-post-result");return i.ncselect2({width:"70%",dropdownCssClass:"nc-ncselect2-above-jquery-dialog nc-post-selector-in-message-editor",data:[s],ajax:{url:ajaxurl,dataType:"json",delay:250,data:function(e){var t={action:"nelio_content_get_posts",term:e.term,page:e.page,status:"publish"};return t},processResults:function(e,t){t.page=t.page||1;for(var i=0;i<e.items.length;++i)e.items[i].title=NelioContent.helpers.decodeHTMLEntities(e.items[i].titleFormatted),e.items[i].excerpt=NelioContent.helpers.decodeHTMLEntities(e.items[i].excerptFormatted),e.items[i].titleFormatted=_.escape(e.items[i].title),e.items[i].excerptFormatted=_.escape(e.items[i].excerpt),e.items[i].authorNameFormatted=_.escape(e.items[i].authorName),e.items[i].text=e.items[i].titleFormatted;return{results:e.items,pagination:{more:e.more}}},cache:!1},templateResult:function(t){return"undefined"==typeof t.titleFormatted?t.text:e(o(t))},templateSelection:function(e){if("undefined"!=typeof e.titleFormatted){var t=new NelioContent.models.Post({id:e.id,author:e.author,date:e.date,excerptFormatted:e.excerptFormatted,image:e.image,imageId:e.imageId,permalink:e.permalink,editLink:e.editLink,status:e.status,titleFormatted:e.titleFormatted});n.stopListening(n.model,"change:postId",n.render),n.model.setPost(t);var i=n.model.get("text");i.indexOf("{permalink}")===-1&&n.model.set("text",i+" {permalink}"),n.listenTo(n.model,"change:postId",n.render)}return e.text}}),this._relatedPostMode="show-post-selector",this.trigger("nc:render"),!1}},_clearFormatOnPaste:function(e){e.preventDefault();var t=e.clipboardData.getData("text/html"),i=e.clipboardData.getData("text/plain");t&&t.length&&(t=t.replace(/\r?\n/g,""),i=NelioContent.helpers.htmlToText(t),i=NelioContent.helpers.trim(i)),i=i.replace(/\r?\n/g,"<br>\r\n"),document.execCommand("insertHTML",!1,i)},_searchProfilesToMention:function(t,i){if(this.__search&&(this.__search.abort(),this.__search=void 0),!("string"!=typeof t||t.length<2)){var s="nc-mentions-search["+t+"]",n=ncstore.get(s);return"undefined"!=typeof n?i(n):void(this.__search=e.ajax({method:"GET",url:NelioContent.apiUri+"/profile/"+this.model.get("profileId")+"/search",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},data:{q:t},success:function(e){ncstore.set(s,e,(new Date).getTime()+828e5),i(e)}}))}},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.TargetSelector=Backbone.View.extend({_networkMeta:void 0,_targets:[],_originalSelection:void 0,_loadingTargets:!0,_$window:void 0,_targetTemplate:NelioContent.helpers.getTemplate("_nc-profile-target"),template:NelioContent.helpers.getTemplate("_nc-target-selector"),events:{"click .nc-profile-target.nc-selectable":"_toggleTargetSelection"},initialize:function(){this._$window=e(window),this.render=_.bind(this.render,this),this._onDialogSave=_.bind(this._onDialogSave,this),this._onDialogCancel=_.bind(this._onDialogCancel,this),this._networkMeta=_.findWhere(NelioContent.networkMetas,{id:this.model.get("network")}),this._originalSelection=[],this.listenTo(this,"nc:render",this.render),this.listenToOnce(this,"nc:load:targets",this._onTargetsLoaded),this.listenToOnce(this,"nc:load:targets",this.render)},render:function(){var e={loadingLabel:this._networkMeta.multiTargetLabels.loading,loadingTargets:this._loadingTargets,explanation:this._networkMeta.multiTargetLabels.explanation,noTargetsAvailable:0===this._targets.length,noTargetsExplanation:this._networkMeta.multiTargetLabels.noBoardsExplanation};this.el.innerHTML=this.template(e);var t=this.$(".nc-targets")[0];return _.each(this._targets,function(e){t.innerHTML+=this._targetTemplate(e)},this),this},setOriginalSelection:function(e){this._originalSelection=e},openDialog:function(){this.trigger("nc:render");var e=[];e.push(NelioContent.helpers.makeDialogCancelButton(this,NelioContent.i18n.actions.cancel)),e.push(NelioContent.helpers.makeDialogSaveButton(this,NelioContent.i18n.actions.save));var t=this;this.$el.dialogS2({title:t._networkMeta.multiTargetLabels.title,buttons:e,draggable:!1,modal:!0,resizable:!1,width:Math.min(560,t._$window.width()-80),dialogClass:"nc-dialog",position:{my:"center top",at:"center top+60"},open:function(){t.listenTo(t,"nc:click:dialog:save",t._onDialogSave),t.listenTo(t,"nc:click:dialog:cancel",t._onDialogCancel);var e=t.$el.parent().find("button.nc-delete-button");e.length>0&&e.blur()},close:function(){t.stopListening(t,"nc:click:dialog:save",t._onDialogSave),t.stopListening(t,"nc:click:dialog:cancel",t._onDialogCancel),t._closeAndDestroy&&(t.$el.dialogS2("destroy"),t.trigger("nc:close:dialog"))}}),this.$el.parent().find(".ui-dialog-titlebar button").prop("disabled",!0),this.$el.parent().find(".ui-dialog-buttonpane button").prop("disabled",!0),this._loadTargets()},_loadTargets:function(){var t=this;e.ajax({url:NelioContent.apiUri+"/profile/"+this.model.get("id")+"/targets",method:"GET",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},timeout:3e4,success:function(e){t.trigger("nc:load:targets",e)},error:function(e){t.$el.dialogS2("close"),NelioContent.helpers.openErrorDialog(e.responseJSON)}})},_onTargetsLoaded:function(e){this._targets=e,_.each(this._targets,function(e){e.selected=_.contains(this._originalSelection,e.name)},this),this._loadingTargets=!1,this.$el.parent().find(".ui-dialog-titlebar button").prop("disabled",!1),this.$el.parent().find(".ui-dialog-buttonpane button").prop("disabled",!1)},_toggleTargetSelection:function(t){var i=t.target||t.srcElement,s=e(i).closest(".nc-selectable").data("target-name"),n=_.findWhere(this._targets,{name:s});"object"==typeof n&&(n.selected=!n.selected),NelioContent.helpers.isSubscribed()||_.each(this._targets,function(e){e.name!==s&&(e.selected=!1)}),this.trigger("nc:render")},_onDialogSave:function(){if(!this._loadingTargets){var e=this.$el.parent(),t=e.find(".ui-dialog-titlebar button, .ui-dialog-buttonpane button:not( .button-primary )"),i=e.find(".ui-dialog-buttonpane button.button-primary");i.prop("disabled",!0),t.prop("disabled",!0),i.html(NelioContent.i18n.feedback.saving);var s=_.filter(this._targets,function(e){return e.selected});this.trigger("nc:update:targets",s),this.$el.dialogS2("close")}},_onDialogCancel:function(){this._loadingTargets||this.$el.dialogS2("close")},close:function(){_.each(_.values(this._views),function(e){"object"==typeof e&&"function"==typeof e.close&&e.close()}),this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.UserSelector=Backbone.View.extend({_userOptionTemplate:NelioContent.helpers.getTemplate("_nc-user-selector-option"),_selectedUserTemplate:NelioContent.helpers.getTemplate("_nc-user-selector-selected-option"),_rendered:!1,_defaultValue:void 0,_single:!1,_$select:void 0,_dropdownCssClass:"nc-ncselect2-above-jquery-dialog",_width:"100%",events:{"change .nc-user-selector":"_onUserChange"},initialize:function(e){"undefined"==typeof e&&(e={}),"undefined"!=typeof e.defaultValue&&(this._defaultValue=e.defaultValue),"boolean"==typeof e.single&&(this._single=e.single),"object"==typeof e.$select?this._$select=e.$select:this._$select=jQuery('<select class="nc-user-selector"></select>'),"string"==typeof e.dropdownCssClass&&(this._dropdownCssClass=e.dropdownCssClass),"string"==typeof e.width&&(this._width=e.width),this.render=_.bind(this.render,this),this._getAjaxData=_.bind(this._getAjaxData,this),this._processResults=_.bind(this._processResults,this),this._templateResult=_.bind(this._templateResult,this),this._templateSelection=_.bind(this._templateSelection,this)},render:function(){if(this._rendered)return this;this._rendered=!0;var e=[];if("number"==typeof this._defaultValue){var t=NelioContent.users.getUser(this._defaultValue);if(t.isLoading())return this.listenToOnce(t,"nc:load",this.render),this.listenToOnce(t,"nc:load:error",this.render),this._rendered=!1,this;e=[t.toJSON()]}var i=this;return this.$el.html(this._$select),this._$select.ncselect2({data:e,dropdownCssClass:this._dropdownCssClass,width:this._width,placeholder:NelioContent.i18n.actions.selectAUser,templateResult:i._templateResult,templateSelection:i._templateSelection,ajax:{url:ajaxurl,cache:!1,dataType:"json",delay:250,data:i._getAjaxData,processResults:i._processResults}}),this.setValue(this._defaultValue),this._single&&this._$select.prop("disabled",!0),this},setValue:function(e){if(!this._rendered)return void(this._defaultValue=e);if("number"==typeof e){var t=_.bind(function(){this.undelegateEvents(),this._$select.empty().html('<option value="'+e+'"></option>').trigger("change"),this.delegateEvents()},this),i=NelioContent.users.getUser(e);i.isLoading()?this.listenToOnce(i,"nc:load",t):t()}},lock:function(){this._$select.prop("disabled",!0)},unlock:function(){this._$select.prop("disabled",!1)},clearSelection:function(){this._$select.val(void 0),this._$select.trigger("change")},_getAjaxData:function(e){var t={action:"nelio_content_get_authors",term:e.term,page:e.page};return t},_processResults:function(e,t){t.page=t.page||1;for(var i=0;i<e.items.length;++i)NelioContent.users.add(e.items[i]),e.items[i]=NelioContent.users.get(e.items[i].id).toJSON();return{results:e.items,pagination:{more:e.more}}},_templateResult:function(t){return"undefined"==typeof t.name?t.text:e(this._userOptionTemplate(t))},_templateSelection:function(t){return isNaN(parseInt(t.id))?t.text:(t=NelioContent.users.getUser(t.id).toJSON(),e(this._selectedUserTemplate(t)))},_onUserChange:function(t){var i=t.target||t.srcElement,s=e(i),n=NelioContent.helpers.trim(s.val());n=isNaN(parseInt(n))?n:parseInt(n),this.trigger("nc:change",n)},close:function(){this._rendered&&this._$select.ncselect2("destroy"),this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.UserFilter=NelioContent.views.UserSelector.extend({_actions:!1,_labels:!1,initialize:function(e){"undefined"==typeof e.defaultValue&&(e.defaultValue="all"),NelioContent.views.UserSelector.prototype.initialize.call(this,e),this._actions=jQuery.extend({},{all:!0,none:!1},e.actions),this._labels=jQuery.extend({},{group:!1,all:!1,none:!1,single:!1},e.labels),this._getAjaxData=_.bind(this._getAjaxData,this),this._processResults=_.bind(this._processResults,this),this._templateResult=_.bind(this._templateResult,this),this._templateSelection=_.bind(this._templateSelection,this)},render:function(){if(this._rendered)return this;if("number"==typeof this._defaultValue&&0<this._defaultValue){var e=NelioContent.users.getUser(this._defaultValue);e.isLoading()||e.get("existsInWordPress")||(this._defaultValue="all")}return NelioContent.views.UserSelector.prototype.render.call(this),"all"===this._defaultValue?(this._$select.val("all"),this._$select.empty().append('<option value="all">'+_.escape(this._labels.all)+"</option>").trigger("change")):"none"===this._defaultValue&&(this._$select.val("none"),this._$select.empty().append('<option value="none">'+_.escape(this._labels.none)+"</option>").trigger("change")),this},_getAjaxData:function(e){var t={action:"nelio_content_get_authors",term:e.term,page:e.page};return t},_processResults:function(e,t){var i=NelioContent.views.UserSelector.prototype._processResults.call(this,e,t);return this._labels.group&&1===t.page&&i.results.length&&i.results.unshift({text:this._labels.group,children:[]}),t.term=t.term||"",1!==t.page||t.term.length||(this._actions.none&&i.results.unshift({id:"none"}),this._actions.all&&i.results.unshift({id:"all"})),i},_templateResult:function(e){return"all"===e.id?this._actions.all:"none"===e.id?this._actions.none:NelioContent.views.UserSelector.prototype._templateResult.call(this,e)},_templateSelection:function(t){if("all"===t.id)return this._labels.all;if("none"===t.id){var i='<span class="nc-dashicons nc-dashicons-hidden"></span> ';return e("<span>"+i+this._labels.none+"</span>")}return this._labels.single?"string"==typeof t.name?this._labels.single.replace("%s",t.name):t.text:NelioContent.views.UserSelector.prototype._templateSelection.call(this,t)}}),NelioContent.views.SingleProfileSelector=Backbone.View.extend({_profileTemplate:{"default":NelioContent.helpers.getTemplate("_nc-single-profile-selector-profile"),selected:NelioContent.helpers.getTemplate("_nc-single-profile-selector-selected-profile")},_targetTemplate:NelioContent.helpers.getTemplate("_nc-single-profile-selector-target"),_previousTargetName:"",_targetDataLoader:void 0,_rendered:!1,events:{"change select.nc-profile":"_changeProfile","change select.nc-target":"_changeTarget"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this.model,"change:profileId",this._changeSelectedProfile),this.listenTo(this.model,"change:profileId",this._fixTargetSelectorVisibility)},render:function(){if(this._rendered)return this;this._rendered=!0;var t=jQuery('<div class="nc-profile-container"></div>'),i=jQuery('<select class="nc-profile" name="profile"></select>');t.html(i),this.$el.html(t);var s=this;i.ncselect2({dropdownCssClass:"nc-ncselect2-above-jquery-dialog",data:NelioContent.profiles.toJSON(),width:"100%",matcher:function(e,t){if("object"!=typeof e||"string"!=typeof e.term)return t;e=e.term;var i=t.displayName+" "+t.username;return i.toLowerCase().indexOf(e.toLowerCase())!==-1?(t=_(t).clone(),t.displayNameEscaped=NelioContent.helpers.strongify(_.escape(t.displayName),e),t.usernameEscaped=NelioContent.helpers.strongify(_.escape(t.username),e),t):null},templateResult:function(t){return"undefined"==typeof t.displayName?t.text:e(s._profileTemplate["default"](t))},templateSelection:function(t){return e(s._profileTemplate.selected(t))}}),i.val(this.model.get("profileId")).trigger("change");var n=jQuery('<div class="nc-target-container"></div>'),o=jQuery('<select class="nc-target" name="target"></select>');return n.html(o),o.hide(),this.$el.append(n),this._fixTargetSelectorVisibility(),this},lock:function(){this._isLocked=!0,this.$("select.nc-profile").prop("disabled",!0),this.$("select.nc-target").prop("disabled",!0)},_changeProfile:function(){this.stopListening(this.model,"change:profileId",this._changeSelectedProfile);
var e=NelioContent.profiles.get(NelioContent.helpers.trim(this.$("select.nc-profile").val()));"undefined"!=typeof e&&this.model.set("profileId",e.get("id")),this.listenTo(this.model,"change:profileId",this._changeSelectedProfile),this._maybeFixNewMessageInfo()},_changeTarget:function(){var e=this.$("select.nc-target"),t=e.val(),i=e.ncselect2("data"),s=_.findWhere(i,{id:t});"undefined"!=typeof s?(this.model.set("targetName",s.name),this.model.set("targetDisplayName",s.displayName)):(this.model.set("targetName","default"),this.model.set("targetDisplayName","")),this._maybeFixNewMessageInfo()},_changeSelectedProfile:function(){this.stopListening(this.model,"change:profileId",this._changeSelectedProfile),this.$("select").val(this.model.get("profileId")).trigger("change"),this.listenTo(this.model,"change:profileId",this._changeSelectedProfile)},_fixTargetSelectorVisibility:function(){if(this._rendered){var t=this.$(".nc-target");t.ncselect2(),t.ncselect2("destroy"),"undefined"!=typeof this._targetDataLoader&&("function"==typeof this._targetDataLoader.abort&&this._targetDataLoader.abort(),this._targetDataLoader=void 0);var i=NelioContent.profiles.get(this.model.get("profileId"));if(i.allowsMultiTargets()){var s=_.findWhere(NelioContent.networkMetas,{id:this.model.get("network")}),n=this;t.val(""),t.ncselect2({placeholder:s.multiTargetLabels.loading,width:"100%"}),this._targetDataLoader=e.ajax({url:NelioContent.apiUri+"/profile/"+i.get("id")+"/targets",method:"GET",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},success:function(e){n._buildTargetSelector(e),n._targetDataLoader=void 0},error:function(){n._targetDataLoader=void 0}}),this._previousTargetName=this.model.get("targetName"),this.model.set("targetName",""),this.model.set("targetDisplayName","")}else this.model.set("targetName","default"),this.model.set("targetDisplayName","")}},_buildTargetSelector:function(t){var i=this.$(".nc-target"),s=this;if(i.ncselect2({dropdownCssClass:"nc-ncselect2-above-jquery-dialog",width:"100%",data:t,matcher:function(e,t){return"object"!=typeof e||"string"!=typeof e.term?t:(e=e.term,t.displayName.toLowerCase().indexOf(e.toLowerCase())!==-1?(t=_(t).clone(),t.displayNameEscaped=NelioContent.helpers.strongify(t.displayName,e),t):null)},templateResult:function(t){return"undefined"==typeof t.displayName?t.text:("undefined"==typeof t.displayNameEscaped&&(t.displayNameEscaped=_.escape(t.displayName)),e(s._targetTemplate(t)))},templateSelection:function(t){return"undefined"!=typeof t.displayName&&"undefined"==typeof t.displayNamedEscaped&&(t.displayNameEscaped=_.escape(t.displayName)),e(s._targetTemplate(t))}}),!(t.length<=0)){var n=t[0],o=_.findWhere(t,{name:this._previousTargetName});"undefined"!=typeof o&&(n=o),i.val(n.id).trigger("change"),this._previousTargetName=""}},_maybeFixNewMessageInfo:function(){this.model.isNew()&&this.model.set("profiles",[{id:this.model.get("profileId"),targetName:this.model.get("targetName"),targetDisplayName:this.model.get("targetDisplayName")}])},close:function(){this._rendered&&(this.$("select.nc-profile").ncselect2("destroy"),this.$("select.nc-target").ncselect2(),this.$("select.nc-target").ncselect2("destroy")),this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.SingleProfileSelector=Backbone.View.extend({_profileTemplate:{"default":NelioContent.helpers.getTemplate("_nc-single-profile-selector-profile"),selected:NelioContent.helpers.getTemplate("_nc-single-profile-selector-selected-profile")},_targetTemplate:NelioContent.helpers.getTemplate("_nc-single-profile-selector-target"),_previousTargetName:"",_targetDataLoader:void 0,_rendered:!1,events:{"change select.nc-profile":"_changeProfile","change select.nc-target":"_changeTarget"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this.model,"change:profileId",this._changeSelectedProfile),this.listenTo(this.model,"change:profileId",this._fixTargetSelectorVisibility)},render:function(){if(this._rendered)return this;this._rendered=!0;var t=jQuery('<div class="nc-profile-container"></div>'),i=jQuery('<select class="nc-profile" name="profile"></select>');t.html(i),this.$el.html(t);var s=this;i.ncselect2({dropdownCssClass:"nc-ncselect2-above-jquery-dialog",data:NelioContent.profiles.toJSON(),width:"100%",matcher:function(e,t){if("object"!=typeof e||"string"!=typeof e.term)return t;e=e.term;var i=t.displayName+" "+t.username;return i.toLowerCase().indexOf(e.toLowerCase())!==-1?(t=_(t).clone(),t.displayNameEscaped=NelioContent.helpers.strongify(_.escape(t.displayName),e),t.usernameEscaped=NelioContent.helpers.strongify(_.escape(t.username),e),t):null},templateResult:function(t){return"undefined"==typeof t.displayName?t.text:e(s._profileTemplate["default"](t))},templateSelection:function(t){return e(s._profileTemplate.selected(t))}}),i.val(this.model.get("profileId")).trigger("change");var n=jQuery('<div class="nc-target-container"></div>'),o=jQuery('<select class="nc-target" name="target"></select>');return n.html(o),o.hide(),this.$el.append(n),this._fixTargetSelectorVisibility(),this},lock:function(){this._isLocked=!0,this.$("select.nc-profile").prop("disabled",!0),this.$("select.nc-target").prop("disabled",!0)},_changeProfile:function(){this.stopListening(this.model,"change:profileId",this._changeSelectedProfile);var e=NelioContent.profiles.get(NelioContent.helpers.trim(this.$("select.nc-profile").val()));"undefined"!=typeof e&&this.model.set("profileId",e.get("id")),this.listenTo(this.model,"change:profileId",this._changeSelectedProfile),this._maybeFixNewMessageInfo()},_changeTarget:function(){var e=this.$("select.nc-target"),t=e.val(),i=e.ncselect2("data"),s=_.findWhere(i,{id:t});"undefined"!=typeof s?(this.model.set("targetName",s.name),this.model.set("targetDisplayName",s.displayName)):(this.model.set("targetName","default"),this.model.set("targetDisplayName","")),this._maybeFixNewMessageInfo()},_changeSelectedProfile:function(){this.stopListening(this.model,"change:profileId",this._changeSelectedProfile),this.$("select").val(this.model.get("profileId")).trigger("change"),this.listenTo(this.model,"change:profileId",this._changeSelectedProfile)},_fixTargetSelectorVisibility:function(){if(this._rendered){var t=this.$(".nc-target");t.ncselect2(),t.ncselect2("destroy"),"undefined"!=typeof this._targetDataLoader&&("function"==typeof this._targetDataLoader.abort&&this._targetDataLoader.abort(),this._targetDataLoader=void 0);var i=NelioContent.profiles.get(this.model.get("profileId"));if(i.allowsMultiTargets()){var s=_.findWhere(NelioContent.networkMetas,{id:this.model.get("network")}),n=this;t.val(""),t.ncselect2({placeholder:s.multiTargetLabels.loading,width:"100%"}),this._targetDataLoader=e.ajax({url:NelioContent.apiUri+"/profile/"+i.get("id")+"/targets",method:"GET",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},success:function(e){n._buildTargetSelector(e),n._targetDataLoader=void 0},error:function(){n._targetDataLoader=void 0}}),this._previousTargetName=this.model.get("targetName"),this.model.set("targetName",""),this.model.set("targetDisplayName","")}else this.model.set("targetName","default"),this.model.set("targetDisplayName","")}},_buildTargetSelector:function(t){var i=this.$(".nc-target"),s=this;if(i.ncselect2({dropdownCssClass:"nc-ncselect2-above-jquery-dialog",width:"100%",data:t,matcher:function(e,t){return"object"!=typeof e||"string"!=typeof e.term?t:(e=e.term,t.displayName.toLowerCase().indexOf(e.toLowerCase())!==-1?(t=_(t).clone(),t.displayNameEscaped=NelioContent.helpers.strongify(t.displayName,e),t):null)},templateResult:function(t){return"undefined"==typeof t.displayName?t.text:("undefined"==typeof t.displayNameEscaped&&(t.displayNameEscaped=_.escape(t.displayName)),e(s._targetTemplate(t)))},templateSelection:function(t){return"undefined"!=typeof t.displayName&&"undefined"==typeof t.displayNamedEscaped&&(t.displayNameEscaped=_.escape(t.displayName)),e(s._targetTemplate(t))}}),!(t.length<=0)){var n=t[0],o=_.findWhere(t,{name:this._previousTargetName});"undefined"!=typeof o&&(n=o),i.val(n.id).trigger("change"),this._previousTargetName=""}},_maybeFixNewMessageInfo:function(){this.model.isNew()&&this.model.set("profiles",[{id:this.model.get("profileId"),targetName:this.model.get("targetName"),targetDisplayName:this.model.get("targetDisplayName")}])},close:function(){this._rendered&&(this.$("select.nc-profile").ncselect2("destroy"),this.$("select.nc-target").ncselect2(),this.$("select.nc-target").ncselect2("destroy")),this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.MultipleProfileSelector=Backbone.View.extend({_disabledProfileIds:[],_isLocked:!1,_profileTemplate:NelioContent.helpers.getTemplate("_nc-multiple-profile-selector-profile"),_availableSocialNetworks:void 0,_activeNetwork:"none",_targetSelectorDialog:void 0,template:NelioContent.helpers.getTemplate("_nc-multiple-profile-selector"),events:{"click .nc-available-networks .nc-network":"_changeNetwork","click .nc-profiles .nc-profile:not( .nc-disabled )":"_onProfileClicked"},initialize:function(e){"undefined"==typeof e&&(e={}),this._availableSocialNetworks={},_.each(NelioContent.profiles.pluck("network"),function(e){this._availableSocialNetworks[e]=0},this),_.each(this.model.get("profiles"),function(e){var t=e.id,i=NelioContent.profiles.get(t);"undefined"!=typeof i&&("undefined"==typeof this._availableSocialNetworks[i.get("network")]&&(this._availableSocialNetworks[i.get("network")]=0),this._availableSocialNetworks[i.get("network")]+=1)},this),this._activeNetwork=NelioContent.profiles.at(0).get("network"),_.every(NelioContent.profiles.pluck("network"),function(e){return!(this._availableSocialNetworks[e]>0)||(this._activeNetwork=e,!1)},this),this.model.set("profileId",this._findBestProfileInNetwork(this._activeNetwork).get("id")),this.render=_.bind(this.render,this),this.listenTo(this,"nc:change:selectedProfile",this.render),this.listenTo(this,"nc:change:activeNetwork",this.render)},render:function(){this.$el.find(".nc-profile.nc-disabled").tooltip("destroy"),this.el.innerHTML=this.template();var t=this._activeNetwork,i=this.$(".nc-available-networks");_.mapObject(this._availableSocialNetworks,function(s,n){var o=e('<div class="nc-network nc-status"></div>');o.data("network",n),o.addClass("nc-"+n),i.append(o),s>0&&o.addClass("nc-selected"),n===t&&o.addClass("nc-active")}),_.keys(this._availableSocialNetworks).length<=1&&i.hide();var s=this.$(".nc-profiles"),n=this._disabledProfileIds,o=NelioContent.profiles.where({network:this._activeNetwork});return _.each(o,function(t){var i=t.toJSON();i.disabled=_.contains(n,t.get("id")),i.allowsMultiTargets=t.allowsMultiTargets(),t.allowsMultiTargets()?(i.allowsMultiTargets=!0,i.targetCount=_.filter(_.pluck(this.model.get("profiles"),"id"),function(e){return e===t.get("id")}).length,i.targetCount>9&&(i.targetCount="9-plus"),i.selected=i.targetCount>0):i.selected=_.contains(_.pluck(this.model.get("profiles"),"id"),t.get("id")),s.append(e(this._profileTemplate(i)))},this),this.$el.find(".nc-profile.nc-disabled").tooltip({position:{my:"left bottom",at:"right-5 top+5"},tooltipClass:"nc_tooltip nc_warning_tooltip",show:!1,hide:!1}),this},lock:function(){this._isLocked=!0},disableProfiles:function(e){this._disabledProfileIds=e},_changeNetwork:function(t){if(!this._isLocked){var i=t.target||t.srcElement,s=e(i).closest(".nc-network"),n=s.data("network");if(n!==this._activeNetwork){this._activeNetwork=n,this.trigger("nc:change:activeNetwork");var o=this._findBestProfileInNetwork(n);this.model.set("profileId",o.get("id"))}}},_onProfileClicked:function(t){if(!this._isLocked){var i=t.target||t.srcElement,s=e(i).closest(".nc-profile"),n=NelioContent.profiles.get(s.data("profile"));n.allowsMultiTargets()?this._selectTargets(n):this._toggleProfileSelection(n)}},_selectTargets:function(e){this._targetSelectorDialog=new NelioContent.views.TargetSelector({model:e});var t=_.where(this.model.get("profiles"),{id:e.get("id")});this._targetSelectorDialog.setOriginalSelection(_.pluck(t,"targetName"));var i=this;this.listenTo(this._targetSelectorDialog,"nc:update:targets",function(t){var s=_(this.model.get("profiles")).clone(),n=[];_.each(s,function(t){t.id!==e.get("id")&&n.push(t)}),_.each(t,function(t){n.push({id:e.get("id"),targetName:t.name,targetDisplayName:t.displayName})}),i.model.set("profiles",n),i._selectProfileForPreview(e)}),this.listenTo(this._targetSelectorDialog,"nc:close:dialog",function(){i.stopListening(i._targetSelectorDialog),i._targetSelectorDialog.close(),i._targetSelectorDialog=void 0}),this._targetSelectorDialog.openDialog()},_toggleProfileSelection:function(e){var t=_(this.model.get("profiles")).clone(),i=_.contains(_.pluck(t,"id"),e.get("id"));if(i){var s=_.filter(t,function(t){return t.id===e.get("id")});s.length>0&&(s=s[0],t=_.without(t,s))}else t.push({id:e.get("id"),targetName:"default",targetDisplayName:""});this.model.set("profiles",t),this._selectProfileForPreview(e)},_selectProfileForPreview:function(e){var t=this.model.get("profiles"),i=NelioContent.profiles.filter(function(i){return i.get("network")===e.get("network")&&_.contains(_.pluck(t,"id"),i.get("id"))});this._availableSocialNetworks[e.get("network")]=i.length;var s=_.pluck(this.model.get("profiles"),"id");if(_.contains(s,e.get("id")))this.model.set("profileId",e.get("id"));else if(this.model.get("profileId")===e.get("id")){var n=this._findBestProfileInNetwork(e.get("network"));this.model.set("profileId",n.get("id"))}this.trigger("nc:change:selectedProfile")},_findBestProfileInNetwork:function(e){var t=_.pluck(this.model.get("profiles"),"id"),i=NelioContent.profiles.filter(function(i){return i.get("network")===e&&_.contains(t,i.get("id"))}),s=i[0];return"undefined"==typeof s&&(s=NelioContent.profiles.findWhere({network:e})),s},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.SocialMessagePreview=Backbone.View.extend({_profileInformation:{displayName:"David Aguilera",firstLetter:"d",username:"@davilera, Nelio Software",photo:"https://twitter.com/davilera/profile_image"},_warningTemplate:NelioContent.helpers.getTemplate("_nc-preview-warning-message"),_sharedLinkInformation:{title:"",excerpt:"",permalink:"",domain:"",date:!1,author:"",image:"",status:"invalid",_ajaxRequest:void 0,_isBasedOnTheRelatedPost:!1},initialize:function(){this.render=_.bind(this.render,this),this._getUrlMetaData=_.bind(this._getUrlMetaData,this),this.listenTo(this,"nc:getUrlMetaData",_.debounce(this._getUrlMetaData,300)),this.listenTo(this,"nc:change:sharedLink",this.render),this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"change:profileId",this._updateProfileInformation),this.listenTo(this.model,"change:_previewUrl",this._maybeObtainSharedLinkInformation),this._sharedLinkInformation.permalink="",this._sharedLinkInformation.status="invalid",this._updateProfileInformation(),this._maybeObtainSharedLinkInformation()},render:function(){var e=_.pluck(NelioContent.profiles.where({network:this.model.get("network")}),"id"),t=_.pluck(this.model.get("profiles"),"id");if(this.model.isNew()&&0===_.intersection(e,t).length)return this.el.innerHTML=this._warningTemplate(i),this;var i=this.model.toJSON();if(i.textFormatted=this._beautifyLinks(this.model.getPreviewText()),i.profile=this._profileInformation,i.sharedLink=this._sharedLinkInformation,0===this.model.get("postId")||this.model.post.isPublished()||this.model.post.isScheduled())i.dateFormatted=this.formatDate(this.model.get("schedule"));else if("exact"===this.model.get("dateType")&&/[12][0-9][0-9][0-9]-[01][0-9]-[0-3][0-9]/.test(this.model.get("dateValue"))){var s=this.model.get("dateValue")+" "+this.model.get("timeValue");s=ncNewLocalMoment(s),i.dateFormatted=this.formatDate(s)}else i.dateFormatted=NelioContent.i18n.dates.someday;return this.el.innerHTML=this.template(i),this},beautifyLink:function(e){return e},formatDate:function(e){return e.format("YYYY-MM-DD h:mm a")},_beautifyLinks:function(e){var t,i;t=_.uniq(e.match(/"nc-link">[^<]+</g));for(var s=0;s<t.length;++s)i=t[s].replace('"nc-link">',"").replace("<",""),e=e.replace(t[s],'"nc-link">'+this.beautifyLink(i)+"<");return e},_updateProfileInformation:function(){var e=NelioContent.profiles.get(this.model.get("profileId"));"undefined"==typeof e&&(e=NelioContent.profiles.at(0)),this._profileInformation={displayName:e.get("displayName"),firstLetter:e.get("firstLetter"),username:e.get("username"),photo:e.get("photo")}},_setSharedLinkStatus:function(e){this._sharedLinkInformation.status=e,this.trigger("nc:change:sharedLink:status"),this.trigger("nc:change:sharedLink")},_maybeObtainSharedLinkInformation:function(){var e=this.model.get("_previewUrl"),t=this.model.post.toJSON();if("undefined"!=typeof this._sharedLinkInformation._ajaxRequest&&(this._sharedLinkInformation._ajaxRequest.abort(),this._setSharedLinkStatus("invalid")),0===e.length)this._sharedLinkInformation.permalink="",this._setSharedLinkStatus("invalid");else if(e===this._sharedLinkInformation.permalink);else if(e!==t.permalink||"error"===this._sharedLinkInformation.status)this._setSharedLinkStatus("loading"),this._sharedLinkInformation._isBasedOnTheRelatedPost=!1,this.trigger("nc:getUrlMetaData",e);else if(e===t.permalink&&this.model.get("postId")===t.id){this._sharedLinkInformation._isBasedOnTheRelatedPost=!0;var i=NelioContent.users.getUser(t.author);i.isLoading()?i.listenToOnce(i,"nc:load",_.bind(function(){this._maybeObtainSharedLinkInformation()},this)):(t.author=i.get("name"),"undefined"!=typeof t.image&&0!==t.image.length||(t.image=t.autoImage),this._updateSharedLinkInformation(t),this._setSharedLinkStatus("ready"))}},_getUrlMetaData:function(t){var i=this;this._sharedLinkInformation._ajaxRequest=e.ajax({url:ajaxurl,data:{action:"nelio_content_get_url_meta_data",url:t},success:function(e){e.title=NelioContent.helpers.decodeHTMLEntities(e.title),e.excerpt=NelioContent.helpers.decodeHTMLEntities(e.excerpt),i._updateSharedLinkInformation(e),"error"!==i._sharedLinkInformation.status&&i._setSharedLinkStatus("ready")},error:function(){i._setSharedLinkStatus("error")}})},_updateSharedLinkInformation:function(e){switch("undefined"==typeof e.image&&(e.image=""),e.responseCode){case 403:case 404:case 500:return this._sharedLinkInformation.status="error",this.trigger("nc:change:sharedLink:status"),void this.trigger("nc:change:sharedLink")}if("undefined"==typeof e.title||0===NelioContent.helpers.trim(e.title).length)return this._sharedLinkInformation.status="error",this.trigger("nc:change:sharedLink:status"),void this.trigger("nc:change:sharedLink");var t=!1,i=["id","title","excerpt","permalink","date","author"];if(_.each(i,function(i){var s=e[i];"undefined"==typeof s&&(s=""),"excerpt"===i&&s.length>90&&(s=s.substring(0,90)+""),this._sharedLinkInformation[i]!==s&&(this._sharedLinkInformation[i]=s,this.trigger("nc:change:sharedLink:"+i),t=!0)},this),this._sharedLinkInformation.image!==e.image&&(this._sharedLinkInformation.image=e.image,this.trigger("nc:change:sharedLink:image"),t=!0,e.image.length>0)){var s=new Image;s.onerror=function(){view._sharedLinkInformation.image===e.image&&(view._sharedLinkInformation.image="",view.trigger("nc:change:sharedLink:image"),view.trigger("nc:change:sharedLink"))},s.src=e.image}if("string"==typeof e.permalink){var n=this._sharedLinkInformation.permalink;n=n.replace(/^https?:\/\//,""),n.indexOf("/")>0&&(n=n.substring(0,n.indexOf("/"))),n!==this._sharedLinkInformation.domain&&(this._sharedLinkInformation.domain=n,this.trigger("nc:change:sharedLink:domain"),t=!0)}t&&this.trigger("nc:change:sharedLink")},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.FacebookPreview=NelioContent.views.SocialMessagePreview.extend({template:NelioContent.helpers.getTemplate("_nc-facebook-preview"),beautifyLink:function(e){return e.length>60&&(e="/"===e[e.length-1]?e.substring(0,58)+"/":e.substring(0,59)+""),e},formatDate:function(e){return e.format(NelioContent.i18n.dates.preview.facebook)}}),NelioContent.views.GooglePlusPreview=NelioContent.views.SocialMessagePreview.extend({template:NelioContent.helpers.getTemplate("_nc-googleplus-preview"),beautifyLink:function(e){e=e.replace(/https?:\/\//,"");var t=e.indexOf("/");return t!==-1&&(e=e.substring(0,t)),e},formatDate:function(e){return e.format(NelioContent.i18n.dates.preview.googleplus)}}),NelioContent.views.InstagramPreview=NelioContent.views.SocialMessagePreview.extend({template:NelioContent.helpers.getTemplate("_nc-instagram-preview"),beautifyLink:function(e){e=e.replace(/https?:\/\//,"");var t=e.indexOf("/");return t!==-1&&(e=e.substring(0,t)),e},formatDate:function(e){return e.format(NelioContent.i18n.dates.preview.instagram)}}),NelioContent.views.LinkedInPreview=NelioContent.views.SocialMessagePreview.extend({_links:{},template:NelioContent.helpers.getTemplate("_nc-linkedin-preview"),beautifyLink:function(e){if("undefined"==typeof this._links[e]){var t="https://lnkd.in/",i=Math.floor(10*Math.random()),s=Math.floor(10*Math.random()),n=Math.floor(10*Math.random());t+=n<3?i+"n3Li"+s+"o":n<5?"D4"+i+"vid"+s:n<7?i+"toNI"+s+"v":"ru"+i+s+"Th"+i,this._links[e]=t}return this._links[e]},formatDate:function(e){return e.format(NelioContent.i18n.dates.preview.googleplus)}}),NelioContent.views.PinterestPreview=NelioContent.views.SocialMessagePreview.extend({template:NelioContent.helpers.getTemplate("_nc-pinterest-preview"),beautifyLink:function(e){e=e.replace(/https?:\/\//,"");var t=e.indexOf("/");return t!==-1&&(e=e.substring(0,t)),e},formatDate:function(e){return e.format(NelioContent.i18n.dates.preview.pinterest)}}),NelioContent.views.TwitterPreview=NelioContent.views.SocialMessagePreview.extend({template:NelioContent.helpers.getTemplate("_nc-twitter-preview"),beautifyLink:function(e){e=e.replace(/https?:\/\//,"");var t=e.indexOf("/");if(t!==-1){var i=t+15;i<e.length&&(e=e.substring(0,i)+"")}return e},formatDate:function(e){return"time-interval"===this.model.get("timeType")?e.format(NelioContent.i18n.dates.preview.twitterNoTime):e.format(NelioContent.i18n.dates.preview.twitter)}}),NelioContent.views.DateSelector=Backbone.View.extend({_isLocked:!1,_isDatePickerReady:!1,template:NelioContent.helpers.getTemplate("_nc-date-selector"),events:{"change .nc-value":"_changeDate","keyup  input.nc-value":"_changeDate","click  .nc-change-type":"_changeDateType","click  .nc-datepicker":"_maybeInitDatePicker"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this.model,"change:dateType",this.render)},render:function(){var e=this.$(".nc-datepicker");"date"!==e.prop("type")&&(e.datepicker("destroy"),this._isDatePickerReady=!1);var t=this.model.toJSON();return t.dateOffsetMode=this._getDateOffsetMode(),this.el.innerHTML=this.template(t),this.$(".nc-value").val(this.model.get("dateValue")),this},lock:function(){this._isLocked=!0,this.$("input").prop("disabled",!0),this.$("select").prop("disabled",!0)},_getDateOffsetMode:function(){return 0===this.model.get("postId")?"after-now":this.model.post.isPublished()?"after-now":"positive-days"===this.model.get("dateType")?"after-publication":"undefined"!=typeof this.model.get("task")?"before-publication":"after-publication"},_changeDate:function(t){if(!this._isLocked){var i,s=t.target||t.srcElement,n=e(s);switch(n.data("date-type")){case"exact":i=n.val(),this.model.set("dateValue",i);break;case"negative-days":i=n.val(),0===i.length&&(i="2"),this.model.set("dateValue",i);break;case"positive-days":i=n.val(),0===i.length&&(i="2"),this.model.set("dateValue",i);break;case"predefined-offset":switch(i=n.val()){case"positive-days":case"negative-days":case"exact":this.model.set({dateType:i,dateValue:""});break;default:this.model.set("dateValue",i)}}}},_changeDateType:function(e){if(!this._isLocked)return this.model.set("dateValue","0"),this.model.set("dateType","predefined-offset"),!1},_maybeInitDatePicker:function(e){var t=this.$(".nc-datepicker");this._isDatePickerReady||"exact"!==this.model.get("dateType")||"date"===t.prop("type")||(t.datepicker({dateFormat:"yy-mm-dd",minDate:0}),t.datepicker("show")),this._isDatePickerReady=!0},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.TimeSelector=Backbone.View.extend({_isLocked:!1,template:NelioContent.helpers.getTemplate("_nc-time-selector"),events:{"change .nc-value":"_changeTime","keyup  input.nc-value":"_changeTime","click  .nc-change-type":"_changeTimeType"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this.model,"change:dateType",this._useProperSelector),this.listenTo(this.model,"change:dateValue",this._useProperSelector),this.listenTo(this.model,"change:dateType",this.render),this.listenTo(this.model,"change:dateValue",this.render),this.listenTo(this.model,"change:timeType",this.render)},render:function(){var e=this.model.toJSON();return e.timeOffsetMode=this._getTimeOffsetMode(),this.el.innerHTML=this.template(e),this.$(".nc-value").val(this.model.get("timeValue")),this},lock:function(){this._isLocked=!0,this.$("input").prop("disabled",!0),this.$("select").prop("disabled",!0)},_getTimeOffsetMode:function(){var e=this.model.get("dateType"),t=this.model.get("dateValue");return"predefined-offset"===e&&"0"===t?0===this.model.get("postId")||this.model.post.isPublished()?"after-now":"after-publication":"time-interval"},_changeTime:function(t){if(!this._isLocked){var i,s=t.target||t.srcElement,n=e(s);switch(n.data("time-type")){case"exact":i=n.val(),this.model.set("timeValue",i);break;case"negative-hours":i=n.val(),0===i.length&&(i="2"),this.model.set("timeValue","-"+i);break;case"positive-hours":i=n.val(),0===i.length&&(i="2"),this.model.set("timeValue",i);break;case"time-interval":switch(i=n.val()){case"exact":this.model.set({timeType:i,timeValue:""});break;default:this.model.set("timeValue",i)}break;case"predefined-offset":switch(i=n.val()){case"positive-hours":case"negative-hours":case"exact":this.model.set({timeType:i,timeValue:""});break;default:this.model.set("timeValue",i)}}}},_useProperSelector:function(){if(!this._isLocked){var e=this.model.get("dateType"),t=this.model.get("dateValue"),i=this.model.get("timeType");switch(i){case"exact":break;case"negative-hours":case"positive-hours":case"predefined-offset":"predefined-offset"===e&&"0"===t||(this.model.set("timeValue","morning"),this.model.set("timeType","time-interval"));break;case"time-interval":"predefined-offset"===e&&"0"===t&&(this.model.set("timeValue","0"),this.model.set("timeType","predefined-offset"))}}},_changeTimeType:function(e){if(!this._isLocked)return this.model.set("timeValue","0"),this.model.set("timeType","predefined-offset"),this._useProperSelector(),!1},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}})}(jQuery);