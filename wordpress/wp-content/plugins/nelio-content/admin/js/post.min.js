!function(e){"use strict";function t(t){c.collection.setPost(t),l&&(c.fillTimelineAutomatically(),e("#nelio-content-social-timeline-container").html(c.render().el)),u=new NelioContent.views.Notifications({collection:new NelioContent.collections.Followers(null,{post:t})}),e("#nelio-content-notifications-container").html(u.render().el),e.ajax({url:NelioContent.apiUri+"/post/"+t.get("id")+"/items",method:"GET",headers:{Authorization:"Bearer "+NelioContent.apiAuthToken,"Content-Type":"application/json"},success:function(i){if(l||(c.collection.reset(i.social),c.listenToOnce(NelioContent.profiles,"nc:ready",function(){e("#nelio-content-social-timeline-container").html(c.render().el)}),NelioContent.profiles.isReady()&&NelioContent.profiles.trigger("nc:ready")),d.collection.setPost(t),d.collection.reset(i.tasks),e("#nelio-content-editorial-tasks-container").html(d.render().el),h.collection.setPost(t),NelioContent.helpers.isSubscribed())h.collection.reset(i.comments);else{var n=new NelioContent.models.EditorialComment({comment:NelioContent.i18n.messages.commentFreeMessage,authorId:"davilera",postId:t.get("id"),postType:t.get("type")});h.collection.reset(),h.collection.add(n)}e("#nelio-content-editorial-comments-container").html(h.render().el)},error:function(t){var i=new NelioContent.models.AjaxError;i.parseResponse(t),c.close(),e("#nelio-content-social-timeline-container").html(new NelioContent.views.MetaBoxError({model:i}).render().el),h.close(),e("#nelio-content-editorial-comments-container").html(new NelioContent.views.MetaBoxError({model:i}).render().el),u.close(),e("#nelio-content-notifications-container").html(new NelioContent.views.MetaBoxError({model:i}).render().el),d.close(),e("#nelio-content-editorial-tasks-container").html(new NelioContent.views.MetaBoxError({model:i}).render().el)}})}function i(t){function i(t){var i=parseInt(e("#wp-word-count .word-count").text(),10);if(isNaN(i)||0===i){var n=new wp.utils.WordCounter;i=n.count(t)}g.onLinksChange(NelioContent.helpers.extractReferences(t)),g.onImageCountChange(NelioContent.helpers.countImages(t)),g.onTextLengthChange(i)}function n(e){u.getSuggestedReferences().each(function(t){t.testIfIsInPostContent(e)});var t=NelioContent.helpers.extractReferences(e);t=_.filter(t,NelioContent.helpers.isExternalReference),u.setExternalReferences(t)}t.listenTo(Backbone,"nc:change:featuredImage",function(e){t.set({imageId:e.get("attachmentId"),image:e.get("url")})});var l=new NelioContent.collections.References;l.setPost(t),NCTinyMce.suggestedReferences=l;var h=new NelioContent.collections.References;h.setPost(t),NCTinyMce.externalReferences=h;var u=new NelioContent.views.References({suggestedReferences:l,externalReferences:h});e.ajax({url:ajaxurl,data:{action:"nelio_content_get_post_references",post:e("#post_ID").val()},success:function(t){l.reset(t.suggested),h.reset(_.filter(t.included,function(e){return NelioContent.helpers.isExternalReference(e.url)})),e("#nelio-content-links-container").html(u.render().el)},error:function(t){var i=new NelioContent.models.AjaxError;i.parseResponse(t),e("#nelio-content-links-container").html(new NelioContent.views.MetaBoxError({model:i}).render().el)}}),NelioContent.views.PostAnalysisView=Backbone.View.extend({_areDetailsVisible:ncstore.get("nc-post-analysis-visible-details",!1),_data:{},_summary:"pending",_postStatus:"draft",_postType:"post",_discardPendingTimeout:0,template:NelioContent.helpers.getTemplate("_nc-post-analysis"),events:{"click .nc-details-control":"_toggleDetailsVisibility"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render);var e=this;this.listenTo(this,"nc:change",_.debounce(function(){e.trigger("nc:render")},600)),this._data={author:"pending",excerpt:"pending",externalLinks:"pending",imageCount:"pending",internalLinks:"pending",tag:"pending",textLength:"pending",thumbnail:"pending",social:"pending",tasks:"pending"},NelioContent.helpers.isSubscribed()||(this._data.tasks=void 0),NelioContent.postAnalysis.isYoastSeoIntegrated&&(this._data.yoastSeo="pending",this._data.yoastContent="pending"),this._discardPendingTimeout=setTimeout(function(){e._discardPendingDetails()},15e3)},render:function(){this._updateSummary();var e=_.clone(this._data);return e.isPostPublished="publish"===this._postStatus,e.areDetailsVisible=this._areDetailsVisible,e.summary=this._summary,this.el.innerHTML=this.template(e),this},onPostChange:function(e){this._postStatus=e.get("status"),this._postType=e.get("type"),"post"!==this._postType&&(this._data.tag=void 0),"publish"===this._postStatus&&(this._data.social=void 0);var t=NelioContent.users.getUser(e.get("author"));t.isLoading()?this.listenToOnce(t,"nc:load",_.bind(function(){this._checkAuthor(t),this.trigger("nc:change")},this)):this._checkAuthor(t),NelioContent.helpers.trim(e.get("excerpt")).length<20?this._data.excerpt="improvable":this._data.excerpt="good";var i=e.get("image"),n=e.get("autoImage"),s=_.where(NelioContent.postTypes,{name:e.get("type")}),o=s.length&&s[0].supportsFeaturedImage;e.get("imageId")>0?this._data.thumbnail="good":"string"==typeof i&&i.length>0?this._data.thumbnail="good":"string"==typeof n&&n.length>0?this._data.thumbnail="improvable":o?this._data.thumbnail="bad":this._data.thumbnail=void 0,this.trigger("nc:change")},_checkAuthor:function(e){"administrator"===e.get("role")?this._data.author="improvable":this._data.author="good"},onSocialMessageListUpdate:function(e){"publish"!==this._postStatus&&(0===e.length?this._data.social="bad":1===e.length?this._data.social="improvable":this._data.social="good",this.trigger("nc:change"))},onTaskListUpdate:function(e){if("post"!==this._postType)return this._data.tag=void 0,void this.trigger("nc:change");var t=[];"function"==typeof e.where&&(t=e.where(function(e){return!e.get("completed")})),t.length>0?this._data.tasks="bad":this._data.tasks="good",this.trigger("nc:change")},onLinksChange:function(e){for(var t=0,i=0,n=NelioContent.blogUrl.toLowerCase().replace(/^https:/,"http:"),s=/^[a-zA-Z]+:\/\//,o=0;o<e.length;++o){var a=e[o].toLowerCase().replace(/^https:/,"http:");if(0===a.indexOf(n)?++i:s.test(a)?++t:++i,i>=2&&t>=2)break}0===i?this._data.internalLinks="bad":1===i?this._data.internalLinks="improvable":this._data.internalLinks="good",0===t?this._data.externalLinks="bad":1===t?this._data.externalLinks="improvable":this._data.externalLinks="good",this.trigger("nc:change")},onImageCountChange:function(e){e>0?this._data.imageCount="good":this._data.imageCount="improvable",this.trigger("nc:change")},onTextLengthChange:function(e){var t=NelioContent.postAnalysis.minPostLength;e<Math.floor(.6*t)?this._data.textLength="bad":e<Math.floor(.95*t)?this._data.textLength="improvable":this._data.textLength="good",this.trigger("nc:change")},onTagListUpdate:function(e){"undefined"!=typeof this._data.tag&&(e.length>0?this._data.tag="good":this._data.tag="bad",this.trigger("nc:change"))},onYoastSeoChange:function(e){NelioContent.postAnalysis.isYoastSeoIntegrated&&(this._data.yoastSeo=e,this.trigger("nc:change"))},onYoastContentChange:function(e){NelioContent.postAnalysis.isYoastSeoIntegrated&&(this._data.yoastContent=e,this.trigger("nc:change"))},_toggleDetailsVisibility:function(){this._areDetailsVisible=!this._areDetailsVisible,ncstore.set("nc-post-analysis-visible-details",this._areDetailsVisible),this.trigger("nc:render")},_updateSummary:function(){var e=_.filter(_.values(this._data),function(e){return"pending"===e}).length,t=(_.filter(_.values(this._data),function(e){return"good"===e}).length,_.filter(_.values(this._data),function(e){return"improvable"===e}).length),i=_.filter(_.values(this._data),function(e){return"bad"===e}).length;e>0?this._summary="pending":0===t+i?this._summary="awesome":0===i&&t<3?this._summary="good":1>=i?this._summary="improvable":this._summary="bad"},_discardPendingDetails:function(){clearTimeout(this._discardPendingTimeout),this._discardPendingTimeout=0,this._data=_.object(_.map(this._data,function(e,t){return"pending"===e?[t,"unknown"]:[t,e]})),this.trigger("nc:change")},close:function(){this._discardPendingTimeout>0&&(clearTimeout(this._discardPendingTimeout),this._discardPendingTimeout=0),this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}});var g=new NelioContent.views.PostAnalysisView;if(e("#nelio-content-post-analysis-container").html(g.render().el),g.listenTo(c.collection,"reset",g.onSocialMessageListUpdate),g.listenTo(c.collection,"update",g.onSocialMessageListUpdate),g.onSocialMessageListUpdate(c.collection),NelioContent.helpers.isSubscribed()&&(g.listenTo(d.collection,"reset",g.onTaskListUpdate),g.listenTo(d.collection,"update",g.onTaskListUpdate),g.listenTo(d.collection,"nc:change:model",g.onTaskListUpdate),g.onTaskListUpdate(d.collection)),g.listenTo(t,"change",g.onPostChange),g.onPostChange(t),e("#tax-input-post_tag").on("change keyup",function(){var t=NelioContent.helpers.trim(e("#tax-input-post_tag").val());t=t.replace(", ","").split(""),g.onTagListUpdate(t)}),e("#tax-input-post_tag").trigger("change"),NelioContent.postAnalysis.isYoastSeoIntegrated){var m=function(){var t,i=e("#misc-publishing-actions .yoast-seo-score.keyword-score .image");t=i.hasClass("na")?"unknown":i.hasClass("bad")?"bad":i.hasClass("ok")?"improvable":"good",g.onYoastSeoChange(t)};NelioContent.helpers.addStyle("#misc-publishing-actions .yoast-seo-score.keyword-score { display:none!important; }"),e(window).on("YoastSEO:numericScore",m),m();var f=function(){var t,i=e("#misc-publishing-actions .yoast-seo-score.content-score .image");t=i.hasClass("na")?"unknown":i.hasClass("bad")?"improvable":i.hasClass("ok")?"improvable":"good",g.onYoastContentChange(t)};NelioContent.helpers.addStyle("#misc-publishing-actions .yoast-seo-score.content-score { display:none!important; }"),e(window).on("YoastSEO:numericScore",f),f()}g.onTextLengthChange(e("#wp-word-count .word-count").text());var p=!1;e(document).on("nc:tinymce-editor",function(e,t){function s(){var e=t.getContent();i(e),n(e)}p||(p=!0,t.on("nodechange keyup",NelioContent.helpers.callAndDebounce(s,4e3,1500)),u.suggestedReferences.bind("add reset",NelioContent.helpers.callAndDebounce(function(){n(t.getContent())},4e3,1500)))}),r&&e(document).trigger("nc:tinymce-editor",r),function(){function t(){var e=s.val();i(e),n(e)}var s=e("#content");s.on("nodechange keyup",NelioContent.helpers.callAndDebounce(t,4e3,1500)),u.suggestedReferences.bind("add reset",NelioContent.helpers.callAndDebounce(function(){n(s.val())},4e3,1500));try{QTags.addButton("nc-share-selection",NelioContent.i18n.actions.shareSelection,function(e,t){var i=NelioContent.helpers.getSelection(t);i=NelioContent.helpers.trim(i),0===i.length&&(i="{title}");var n=new NelioContent.models.SocialMessage;n.setPost(NCTinyMce.timelineView.collection.post),n.set("text",i+" {permalink}"),n.set("profileId",NelioContent.profiles.at(0).get("id"));var s=new NelioContent.views.SocialMessageEditor({model:n});Backbone.listenToOnce(s,"nc:add:messages",function(e){NCTinyMce.timelineView.collection.add(e)}),s.render()})}catch(o){}}(),s.on("change",_.debounce(function(){t.set("title",NelioContent.helpers.decodeHTMLEntities(s.val()))},2e3)),o.on("change",_.debounce(function(){t.set("excerpt",NelioContent.helpers.decodeHTMLEntities(o.val()))},2e3)),a.on("change",_.debounce(function(){t.set("author",parseInt(a.val(),10))},500))}NelioContent.views.SocialTimeline=Backbone.View.extend({_isLocked:!1,_isAutoGeneratingSocialMessages:!1,className:"nc-social-timeline",_overview:{$instance:void 0,sections:{$before:void 0,$day:void 0,$nextDay:void 0,$week:void 0,$month:void 0,$later:void 0},marks:{$start:void 0,$end:void 0},isFixed:!1,lastHighlightedBlock:"day",ignoreNextAutoHighlight:!1},_$blocks:{before:void 0,day:void 0,nextDay:void 0,week:void 0,month:void 0,later:void 0},_messageViews:{before:[],day:[],nextDay:[],week:[],month:[],later:[]},_socialMessageEditorView:void 0,_adminBarHeight:32,_$window:void 0,_$document:void 0,_templates:{autoGeneratingSocialMessages:NelioContent.helpers.getTemplate("_nc-auto-generating-social-messages"),normal:NelioContent.helpers.getTemplate("_nc-social-timeline"),noProfiles:NelioContent.helpers.getTemplate("_nc-no-profile-available"),autoDraft:NelioContent.helpers.getTemplate("_nc-no-social-timeline-on-auto-draft")},events:{"click .nc-timeline-overview .nc-section":"_gotoSection","click .nc-manual-create:not( .nc-disabled )":"_openSocialMessageEditorDialog","click .nc-auto-create":"_savePostToAutogenerateMessages","click .button.nc-action.nc-new-social-message.nc-add-message":"_openSocialMessageEditorDialog","click .button.nc-action.nc-new-social-message.nc-upgrade":"_gotoAccountPage","click .nc-new-social-message.nc-first-message.nc-add-message":"_openSocialMessageEditorDialog","click .nc-new-social-message.nc-first-message.nc-upgrade":"_gotoAccountPage"},initialize:function(){this._$window=e(window),this._$document=e(document),this.collection=new NelioContent.collections.SocialTimeline,this._resetMessageViews(),this.render=_.bind(this.render,this),this._updateMessage=_.bind(this._updateMessage,this),this._addNewMessages=_.bind(this._addNewMessages,this),this.listenTo(this.collection,"add",this._addMessageView),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this._removeMessageView),this.listenTo(this.collection,"remove",this.render),this.listenTo(this.collection,"reset",this._resetMessageViews),this.listenTo(this.collection,"reset",this.render),this.listenTo(this,"nc:render",this.render),this._maybeFixOverview=_.bind(this._maybeFixOverview,this),this._onWindowResize=_.bind(this._onWindowResize,this),this._maybeHighlightADifferentBlockInOverview=_.bind(this._maybeHighlightADifferentBlockInOverview,this),this._$document.on("scroll",this._maybeFixOverview),this._$document.on("scroll",this._maybeHighlightADifferentBlockInOverview),this._$window.on("resize",this._onWindowResize),this._$window.on("resize",this._maybeHighlightADifferentBlockInOverview)},render:function(){if(this._isAutoGeneratingSocialMessages)return this.el.innerHTML=this._templates.autoGeneratingSocialMessages(),this;if(0===NelioContent.profiles.length)return this.el.innerHTML=this._templates.noProfiles(),this;if("undefined"==typeof this.collection.post)return this;if("auto-draft"===this.collection.post.get("status"))return this.el.innerHTML=this._templates.autoDraft(),this;var e={isTimelineVisible:this._isTimelineVisible(),dayStatus:this._getStatus("day"),nextDayStatus:this._getStatus("nextDay"),weekStatus:this._getStatus("week"),monthStatus:this._getStatus("month"),laterStatus:this._getStatus("later"),isPostPublished:this.collection.post.isPublished(),excludedFromReshare:this.collection.post.get("excludedFromReshare")},t=ncNewLocalMoment();if(this.collection.post.isPublished())e.dayFormattedDate=t.format(NelioContent.i18n.dates["default"]),e.nextDayFormattedDate=t.add(1,"d").format(NelioContent.i18n.dates["default"]),e.statistics=this.collection.post.get("statistics");else if(this.collection.post.isScheduled()){var i=this.collection.post.get("date").clone();e.dayFormattedDate=i.format(NelioContent.i18n.dates["default"]),e.nextDayFormattedDate=i.add(1,"d").format(NelioContent.i18n.dates["default"])}else e.dayFormattedDate="",e.nextDayFormattedDate="";if(!NelioContent.helpers.isSubscribed()){var n=this.collection,s=_.map(n.getDisabledProfileIds(),function(e){return n.get(e)});e.areMoreMessagesAllowed=s.length<NelioContent.profiles.length}e.timeSinceLastShare=!1;var o=_.pluck(_.where(this.collection.toJSON(),{status:"publish"}),"sentTime").sort();try{if(o.length){var a=o.sort().reverse()[0];e.timeSinceLastShare=ncLocalizeMoment(ncmoment(a)).fromNow()}}catch(l){e.timeSinceLastShare=!1}return this.el.innerHTML=this._templates.normal(e),this._overview.$instance=this.$(".nc-timeline-overview"),this._overview.marks.$start=this.$("#timeline-start"),this._overview.marks.$end=this.$("#timeline-end"),this._overview.sections.$day=this.$(".nc-timeline-overview .nc-section.nc-day"),this._overview.sections.$nextDay=this.$(".nc-timeline-overview .nc-section.nc-next-day"),this._overview.sections.$week=this.$(".nc-timeline-overview .nc-section.nc-week"),this._overview.sections.$month=this.$(".nc-timeline-overview .nc-section.nc-month"),this._overview.sections.$later=this.$(".nc-timeline-overview .nc-section.nc-later"),this._overview.sections["$"+this._overview.lastHighlightedBlock].addClass("nc-active"),this._populateBlock("day"),this._populateBlock("nextDay"),this._populateBlock("week"),this._populateBlock("month"),this._populateBlock("later"),this._overview.isFixed=!1,this._maybeFixOverview(),this._maybeHighlightADifferentBlockInOverview(),NelioContent.helpers.makeInfoTooltip(this.$(".nc-help-with-html-tooltip")),this._isLocked?(this.$el.addClass("nc-locked"),this.$(".nc-new-social-message").addClass("nc-locked")):(this.$el.removeClass("nc-locked"),this.$(".nc-new-social-message").removeClass("nc-locked")),this},lock:function(){_.mapObject(this._messageViews,function(e){_.each(e,function(e){e.lock()})}),this._isLocked=!0,this.trigger("nc:render")},unlock:function(){_.mapObject(this._messageViews,function(e){_.each(e,function(e){e.unlock()})}),this._isLocked=!1,this.trigger("nc:render")},fillTimelineAutomatically:function(){function e(){t._isAutoGeneratingSocialMessages=!1,t.unlock()}if(!this._isAutoGeneratingSocialMessages){this._isAutoGeneratingSocialMessages=!0,this.trigger("nc:render");var t=this;this.listenToOnce(this.collection,"nc:auto:error",function(t){NelioContent.helpers.openErrorDialog(t),e()}),this.listenToOnce(this.collection,"nc:auto:ready",e),this.collection.fillTimelineAutomatically()}},_populateBlock:function(e){var t=e;"nextDay"===t&&(t="next-day");var i=this.$(".nc-timeline-section.nc-"+t+" .nc-social-messages"),n=this._messageViews[e];i.children().detach(),_.each(n,function(e){i.append(e.render().el)},this),this._$blocks[e]=i},_getStatus:function(e){return"undefined"!=typeof this._messageViews[e]?0===this._messageViews[e].length?"bad":this._messageViews[e].length<2?"improvable":"good":"bad"},_resetMessageViews:function(){function e(e){this.stopListening(e),this.stopListening(e.model),e.close()}_.each(this._messageViews.before,e,this),_.each(this._messageViews.day,e,this),_.each(this._messageViews.nextDay,e,this),_.each(this._messageViews.week,e,this),_.each(this._messageViews.month,e,this),_.each(this._messageViews.later,e,this),this._messageViews={before:[],day:[],nextDay:[],week:[],month:[],later:[]},this.collection.each(this._addMessageView,this)},_addMessageView:function(e){var t="none";if("publish"!==e.get("status")||this.collection.post.isPublished()){if("publish"===e.get("status")||this.collection.post.isPublished()||this.collection.post.isScheduled()){var i,n;this.collection.post.isPublished()?(i=ncNewLocalMoment(),n=i.clone().add(1,"d")):(i=this.collection.post.get("date").clone(),n=i.clone().add(1,"d"));var s=e.get("schedule"),o=s.diff(i,"day");i.isSame(s,"day")?t="day":n.isSame(s,"day")?t="nextDay":0<o&&o<=9?t="week":0<o&&o<=30?t="month":0<o&&(t="later")}else if("exact"===e.get("dateType"))t="later";else{var a=e.get("dateValue");if(a<=0)if("exact"!==e.get("timeType")){var l=e.get("timeValue");t=l<24?"day":l<48?"nextDay":l<216?"week":l<720?"month":"later"}else t="day";else t=a<=1?"nextDay":a<=9?"week":a<=30?"month":"later"}var r=this._extractView(e);if("none"===t)return void("undefined"!=typeof r&&r.close());"undefined"==typeof r&&(r=new NelioContent.views.SocialTimelineMessage({model:e}),this.listenTo(r,"nc:edit",this._openSocialMessageEditorDialog),this.listenTo(r.model,"change:dateValue",this._addMessageView),this.listenTo(r.model,"change:dateValue",this.render),this.listenTo(r.model,"change:timeValue",this._addMessageView),this.listenTo(r.model,"change:timeValue",this.render),this._isLocked&&r.lock()),this._messageViews[t].push(r),this._messageViews[t].sort(function(e,t){var i=e.model.getDateForSorting(),n=t.model.getDateForSorting();return i+="twitter"===e.model.get("network")?"Atwitter":"B"+e.model.get("network"),n+="twitter"===t.model.get("network")?"Atwitter":"B"+t.model.get("network"),i+=e.model.get("profileId")+e.model.get("text"),n+=t.model.get("profileId")+t.model.get("text"),i<n?-1:i>n?1:0})}},_removeMessageView:function(e){var t=this._extractView(e);"undefined"!=typeof t&&(this.stopListening(t),this.stopListening(t.model),t.close())},_extractView:function(e){function t(t){return t.model===e}var i;return _.each(["before","day","nextDay","week","month","later"],function(e){if("undefined"==typeof i){var n=_.filter(this._messageViews[e],t);n.length>0&&(i=n[0],this._messageViews[e]=_.without(this._messageViews[e],i))}},this),i},_fixOverview:function(e){if("undefined"!=typeof this._overview.$instance){if(this._isLocked)return void(this._overview.isFixed&&this._unfixOverview());if(this._overview.$instance.css("top",e),!this._overview.isFixed){var t=this._overview.$instance.width();this._overview.$instance.addClass("nc-fixed"),this._overview.$instance.css("left",this._overview.$instance.offset().left),this._overview.$instance.css("width",t),this._overview.isFixed=!0}}},_unfixOverview:function(){this._overview.isFixed&&(this._overview.$instance.removeClass("nc-fixed"),this._overview.$instance.css("top",""),this._overview.$instance.css("left",""),this._overview.$instance.css("width",""),this._overview.isFixed=!1)},_maybeFixOverview:function(){if(this._isTimelineVisible()&&"undefined"!=typeof this._overview.$instance){var e=280,t=this._$window.scrollTop(),i=this._overview.marks.$start.offset().top-t,n=this._overview.marks.$end.offset().top-t;if(i<=this._adminBarHeight&&n>-100){var s=this._adminBarHeight;n<e&&(s-=e-n),this._fixOverview(s)}else this._unfixOverview()}},_onWindowResize:function(){this._unfixOverview(),this._maybeFixOverview(),this._maybeHighlightADifferentBlockInOverview()},_gotoSection:function(e){for(var t=e.target||e.srcElement,i=0;t.className.indexOf("section")===-1&&i<4;)t=t.parentNode;var n=this._overview.$instance.height()+this._adminBarHeight+75;this._overview.ignoreNextAutoHighlight=!0,t.className.indexOf("nc-later")!==-1?(this._$window.scrollTop(this._$blocks.later.offset().top-n),this._highlightBlockInOverview("later")):t.className.indexOf("nc-month")!==-1?(this._$window.scrollTop(this._$blocks.month.offset().top-n),this._highlightBlockInOverview("month")):t.className.indexOf("nc-week")!==-1?(this._$window.scrollTop(this._$blocks.week.offset().top-n),this._highlightBlockInOverview("week")):t.className.indexOf("nc-next-day")!==-1?(this._$window.scrollTop(this._$blocks.nextDay.offset().top-n),this._highlightBlockInOverview("nextDay")):(this._$window.scrollTop(this._$blocks.day.offset().top-n),this._highlightBlockInOverview("day"))},_gotoAccountPage:function(){document.location.href=NelioContent.pages.account},_maybeHighlightADifferentBlockInOverview:function(){if(this._isTimelineVisible()){if(this._overview.ignoreNextAutoHighlight)return void(this._overview.ignoreNextAutoHighlight=!1);if("undefined"!=typeof this._overview.$instance){var e=this._$window.scrollTop(),t=this._adminBarHeight+this._overview.$instance.height()+80,i=e+t;this._$blocks.later.offset().top<=i?this._highlightBlockInOverview("later"):this._$blocks.month.offset().top<=i?this._highlightBlockInOverview("month"):this._$blocks.week.offset().top<=i?this._highlightBlockInOverview("week"):this._$blocks.nextDay.offset().top<=i?this._highlightBlockInOverview("nextDay"):this._highlightBlockInOverview("day")}}},_highlightBlockInOverview:function(e){this._overview.lastHighlightedBlock!==e&&(this._overview.sections.$later.removeClass("nc-active"),this._overview.sections.$month.removeClass("nc-active"),this._overview.sections.$week.removeClass("nc-active"),this._overview.sections.$nextDay.removeClass("nc-active"),this._overview.sections.$day.removeClass("nc-active"),this._overview.sections["$"+e].addClass("nc-active"),this._overview.lastHighlightedBlock=e)},_openSocialMessageEditorDialog:function(t,i){if(t.preventDefault(),!this._isLocked){var n=new NelioContent.models.SocialMessage;if(n.setPost(this.collection.post),"undefined"==typeof i){var s=t.target||t.srcElement,o=e(s);switch(o.closest(".nc-information").find("h4").attr("name")){case"later":n.set("dateType","exact"),n.set("timeType","time-interval"),n.set("timeValue","morning");break;case"month":n.set("dateValue","28"),n.set("timeType","time-interval"),n.set("timeValue","morning");break;case"week":n.set("dateValue","7"),n.set("timeType","time-interval"),n.set("timeValue","morning");break;case"next-day":n.set("dateValue","1"),n.set("timeType","time-interval"),n.set("timeValue","morning")}n.set("profileId",NelioContent.profiles.at(0).get("id"))}else n.set(i.toJSON());this._socialMessageEditorView=new NelioContent.views.SocialMessageEditor({model:n}),this.listenTo(this._socialMessageEditorView,"nc:add:messages",this._addNewMessages),this.listenTo(this._socialMessageEditorView,"nc:update:message",this._updateMessage),this.listenTo(this._socialMessageEditorView,"nc:delete:message",this._deleteMessage),this.listenTo(this._socialMessageEditorView,"nc:close:dialog",this._onClosingMessageEditorView),this._socialMessageEditorView.disableProfiles(this.collection.getDisabledProfileIds()),this._socialMessageEditorView.render()}},_savePostToAutogenerateMessages:function(t){if(t.preventDefault(),!this._isLocked){this.lock(),this.$(".nc-auto-create").addClass("disabled nc-disabled").html(NelioContent.i18n.feedback.saving),this.$(".nc-manual-create").addClass("disabled nc-disabled");var i=e("form#post");i.append('<input type="hidden" name="_nc_auto_messages" value="true" />');var n=e("#nc-form-submit");n.length?n.click():i.submit()}},_addNewMessages:function(e){this.collection.add(e)},_updateMessage:function(e){"function"==typeof e.toJSON&&(e=e.toJSON());var t=this.collection.get(e.id);"undefined"!=typeof t&&t.clearToDefaults().set(e)},_deleteMessage:function(e){this.collection.remove(e)},_isTimelineVisible:function(){return"undefined"!=typeof this.collection.post&&(this.collection.post.isPublished()||this.collection.length)},_onClosingMessageEditorView:function(){this.stopListening(this._socialMessageEditorView),this._socialMessageEditorView.close(),this._socialMessageEditorView=void 0},close:function(){function e(e){this.stopListening(e),this.stopListening(e.model),e.close()}this._messageViews=[],_.each(this._messageViews.before,e,this),_.each(this._messageViews.day,e,this),_.each(this._messageViews.nextDay,e,this),_.each(this._messageViews.week,e,this),_.each(this._messageViews.month,e,this),_.each(this._messageViews.later,e,this),this._messageViews={before:[],day:[],nextDay:[],week:[],month:[],later:[]},this.stopListening(),this.unbind(),this._$document.off("scroll",this._maybeFixOverview),this._$document.off("scroll",this._maybeHighlightADifferentBlockInOverview),this._$window.off("resize",this._onWindowResize),this._$window.off("resize",this._maybeHighlightADifferentBlockInOverview),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.SocialTimelineMessage=Backbone.View.extend({_isLocked:!1,_deletionStatus:"none",template:NelioContent.helpers.getTemplate("_nc-social-timeline-message"),events:{mouseleave:"_cancelMessageDeletion","click .nc-actions .nc-delete":"_askForMessageDeletionConfirmation","click .nc-actions .nc-cancel-deletion":"_cancelMessageDeletion","click .nc-actions .nc-do-delete":"_deleteMessage","click .nc-actions .nc-edit":"_editMessage","click .nc-actions .nc-share-now":"_shareNow"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.model,"change",this.render)},render:function(){var e=this.model.toJSON(),t=NelioContent.profiles.get(this.model.get("profileId")),i=_.findWhere(NelioContent.networkMetas,{id:this.model.get("network")});return e.networkAllowsMultiTargets=!1,"undefined"!=typeof i&&i.allowsMultiTargets&&(e.networkAllowsMultiTargets=!0,e.targetLabel=i.multiTargetLabels.targetLabel),"undefined"==typeof t&&(t=NelioContent.profiles.at(0)),e.photo=t.get("photo"),e.displayName=t.get("displayName"),e.firstLetter=t.get("firstLetter"),e.textFormatted=this.model.getHighlightedText(),e.textFormatted=e.textFormatted.replace(/>https?:\/\/([^\/<]+)([^<]{0,12})([^<]*)/gi,">$1$2>>>$3<<<").replace(/>>>[^<]+<<</gi,"...").replace(/>>><<</gi,""),e.dateFormatted=this._getDatetimeFormatted(),e.isAuthorMe=this.model.get("authorId")===NelioContent.users.current().get("id"),e.locked=this._isLocked,e.deletionStatus=this._deletionStatus,this.el.innerHTML=this.template(e),"deleting"===this._deletionStatus?this.$el.addClass("nc-deleting"):this.$el.removeClass("nc-deleting"),"image"===this.model.get("type")?this.$(".nc-social-timeline.nc-message").addClass("nc-has-image"):this.$(".nc-social-timeline.nc-message").removeClass("nc-has-image"),this},lock:function(){return this._isLocked=!0,this._deletionStatus="none",this},unlock:function(){return this._isLocked=!1,this._deletionStatus="none",this},_askForMessageDeletionConfirmation:function(){this._deletionStatus="awaiting-confirmation",this.trigger("nc:render")},_cancelMessageDeletion:function(){"awaiting-confirmation"===this._deletionStatus&&(this._deletionStatus="none",this.trigger("nc:render"))},_deleteMessage:function(e){this._deletionStatus="deleting",this.trigger("nc:render"),this.model.destroy()},_editMessage:function(e){this.trigger("nc:edit",e,this.model)},_shareNow:function(){this.model.shareNow()},_getDatetimeFormatted:function(){var e=this._getDateFormatted(),t=this._getTimeFormatted();return e.length>0&&t.length>0?_.escape(e+" • "+t):_.escape(e+t)},_getDateFormatted:function(){if(this.model.post.isPublished()||this.model.post.isScheduled())return this.model.get("schedule").format(NelioContent.i18n.dates["default"]);if("exact"===this.model.get("dateType"))return ncNewLocalMoment(this.model.get("dateValue")+" 12:00").format(NelioContent.i18n.dates["default"]);var e=parseInt(this.model.get("dateValue"));return e>=3?NelioContent.i18n.dates.daysAfterPublication.replace("{days}",e):""},_getTimeFormatted:function(){if(this.model.post.isPublished()||this.model.post.isScheduled())return this.model.get("schedule").format(NelioContent.i18n.time["default"]);if("exact"===this.model.get("timeType"))return this.model.get("timeValue");var e=parseInt(this.model.get("timeValue"));return 0===e?NelioContent.i18n.dates.onPublication:1===e?NelioContent.i18n.dates.oneHourAfterPublication:e>=2?NelioContent.i18n.dates.hoursAfterPublication.replace("{hours}",e):""},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.EditorialComment=Backbone.View.extend({_deletionStatus:"none",_autoRenderTimeout:0,_isBeingSaved:!1,template:NelioContent.helpers.getTemplate("_nc-editorial-comment"),events:{mouseleave:"_cancelCommentDeletion","click .nc-action.nc-delete":"_askForCommentDeletionConfirmation","click .nc-action.nc-cancel-deletion":"_cancelCommentDeletion","click .nc-action.nc-do-delete":"_deleteComment"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render);var e=NelioContent.users.getUser(this.model.get("authorId"));e.isLoading()&&this.listenToOnce(e,"nc:load",_.bind(function(){this.trigger("nc:render")},this))},render:function(){var e=this.model.toJSON();e.deletionStatus=this._deletionStatus,e.isBeingSaved=this._isBeingSaved,e.dateFormatted=this._prepareDate(),ncNewLocalMoment().diff(this.model.get("date"),"m")<15?e.canBeDeleted=!0:e.canBeDeleted=!1;var t=NelioContent.users.getUser(this.model.get("authorId"));return e.isAuthorMe=t.get("id")===NelioContent.users.current().get("id"),e.photo=t.get("photo"),e.displayName=t.get("name"),e.firstLetter=t.get("firstLetter"),"davilera"===t.get("id")&&(e.photo="https://secure.gravatar.com/avatar/fd9a4ef5e8c94fc90a7cef16fa8553a5?s=100&d=mm&r=g",
e.displayName=NelioContent.i18n.messages.davilera,e.firstLetter="d"),this.el.innerHTML=this.template(e),this},setIsBeingSaved:function(e){this._isBeingSaved=e,this.trigger("nc:render")},_prepareDate:function(){this._clearAutoRenderTimeout();var e,t=ncNewLocalMoment(),i=t.clone().add(-1,"d"),n=this.model.get("date");if(t.diff(n,"d")>2)e=n.format(NelioContent.i18n.dates["default"]);else if(n.isSame(i,"day"))e=n.format(NelioContent.i18n.dates.lastDay)+", "+n.format(NelioContent.i18n.time["default"]),this._autoRenderTimeout=setTimeout(this.render,9e5);else if(n.isSame(t,"day")){e=Math.abs(n.diff(t,"h"))>3?n.format(NelioContent.i18n.time["default"]):t.diff(n,"s")<30?n.format(NelioContent.i18n.time.now):NelioContent.helpers.capitalizeFirstLetter(n.fromNow());var s=Math.abs(t.diff(n,"m"));s<1?this._autoRenderTimeout=setTimeout(this.render,2e4):s<5?this._autoRenderTimeout=setTimeout(this.render,6e4):this._autoRenderTimeout=setTimeout(this.render,9e5)}else e=n.format(NelioContent.i18n.dates["default"]);return e},_askForCommentDeletionConfirmation:function(){this._deletionStatus="awaiting-confirmation",this.trigger("nc:render")},_cancelCommentDeletion:function(){"awaiting-confirmation"===this._deletionStatus&&(this._deletionStatus="none",this.trigger("nc:render"))},_deleteComment:function(e){this._deletionStatus="deleting",this.trigger("nc:render"),this.model.destroy()},_clearAutoRenderTimeout:function(){this._autoRenderTimeout>0&&(clearTimeout(this._autoRenderTimeout),this._autoRenderTimeout=0)},close:function(){this._clearAutoRenderTimeout(),this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.EditorialComments=Backbone.View.extend({_commentViews:[],_rendered:!1,template:NelioContent.helpers.getTemplate("_nc-editorial-comments"),events:{"keypress textarea":"_maybeAddComment"},initialize:function(){"undefined"==typeof this.collection&&(this.collection=new NelioContent.collections.EditorialComments),this.collection.each(function(e){var t=new NelioContent.views.EditorialComment({model:e});this._commentViews.push(t)},this),this.render=_.bind(this.render,this),this.listenTo(this.collection,"add",this._addEditorialComment),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this._removeEditorialComment),this.listenTo(this.collection,"remove",this.render),this.listenTo(this.collection,"reset",this._resetCommentViews),this.listenTo(this.collection,"reset",this.render)},render:function(){this._rendered||(this.el.innerHTML=this.template(),this._rendered=!0);var e=this.$(".nc-editorial-comments");return e.children().detach(),_.each(this._commentViews,function(t){e.append(t.render().el)},this),e[0].scrollTop=e[0].scrollHeight,this},addComment:function(e){var t=new NelioContent.views.EditorialComment({model:e});t.setIsBeingSaved(!0),this._commentViews.push(t),this.stopListening(this.collection,"add",this._addEditorialComment),this.collection.add(e),this.listenTo(this.collection,"add",this._addEditorialComment),e.save(void 0,{success:function(i,n){e.set(n),t.setIsBeingSaved(!1)}})},_resetCommentViews:function(){_.each(this._commentViews,function(e){e.close()},this),this._commentViews=[],this.collection.each(this._addEditorialComment,this)},_addEditorialComment:function(e){var t=new NelioContent.views.EditorialComment({model:e});this._commentViews.push(t)},_removeEditorialComment:function(e){var t=_.filter(this._commentViews,function(t){return t.model===e},this);if(t.length>0){var i=t[0];this._commentViews=_.without(this._commentViews,i),this.stopListening(i),i.close()}},_maybeAddComment:function(e){if(13===e.keyCode&&!e.shiftKey){var t=this.$("textarea"),i=NelioContent.helpers.trim(t.val());if(t.val(""),0===i.length)return!1;var n=new NelioContent.models.EditorialComment({comment:i});return this.addComment(n),!1}},close:function(){_.each(this._commentViews,function(e){e.close()},this),this._commentViews=[],this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.Notifications=Backbone.View.extend({_views:{users:void 0},_followerTemplate:NelioContent.helpers.getTemplate("_nc-follower"),template:NelioContent.helpers.getTemplate("_nc-notifications"),events:{"click .nc-discard":"_removeFollower"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this.render),this.listenTo(this.collection.post,"change:author",this._changeAuthor),this.listenTo(this.collection.post,"change:author",this.render),this._views.users=new NelioContent.views.UserSelector({}),this.listenTo(this._views.users,"nc:change",this._onUserSelected)},render:function(){this._views.users.$el.detach();var e={amountOfFollowers:this.collection.length,followerIds:this.collection.pluck("id")};this.el.innerHTML=this.template(e);var t=this.$(".nc-followers");return this.collection.each(_.bind(function(e){var i=e.toJSON();i.isAuthor=this.collection.post.get("author")===e.get("id"),i.isCurrentUser=NelioContent.users.current().get("id")===e.get("id"),t.append(this._followerTemplate(i))},this)),this.$(".nc-users-placeholder").html(this._views.users.render().el),this._views.users.$el.trigger("change"),this},_onUserSelected:function(e){var t=NelioContent.users.getUser(e);this.collection.push(t),this.stopListening(this._views.users,"nc:change",this._onUserSelected),this._views.users.clearSelection(),this.listenTo(this._views.users,"nc:change",this._onUserSelected)},_changeAuthor:function(){var e=NelioContent.users.getUser(this.collection.post.get("author"));e.get("loading")?this.listenToOnce(e,"nc:load",_.bind(function(){this.collection.post.get("author")===e.get("id")&&this.collection.push(e)},this)):this.collection.push(e)},_removeFollower:function(e){var t=e.target||e.srcElement,i=parseInt(t.getAttribute("data-user-id"));if(!isNaN(i)){var n=this.collection.get(i);this.collection.remove(n)}},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.EditorialTask=Backbone.View.extend({_deletionStatus:"none",_isBeingSaved:!1,template:NelioContent.helpers.getTemplate("_nc-editorial-task"),events:{mouseleave:"_cancelTaskDeletion","click .nc-actions .nc-delete":"_askForTaskDeletionConfirmation","click .nc-actions .nc-cancel-deletion":"_cancelTaskDeletion","click .nc-actions .nc-do-delete":"_deleteTask","click input[type=checkbox]:not( .disabled )":"_toggleCompletion"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.model,"change:completed",this.render);var e=NelioContent.users.getUser(this.model.get("assigneeId"));e.isLoading()&&this.listenToOnce(e,"nc:load",_.bind(function(){this.trigger("nc:render")},this))},render:function(){var e=this.model.toJSON();return e.deletionStatus=this._deletionStatus,e.isBeingSaved=this._isBeingSaved,e.isAssignerMe=this.model.get("assignerId")===NelioContent.users.current().get("id"),e.isAssigneeMe=this.model.get("assigneeId")===NelioContent.users.current().get("id"),e.assigneeName=NelioContent.users.getUser(this.model.get("assigneeId")).get("name"),e.isOverdue=!1,e.dateFormatted=this._getDateFormatted(),this.isBeingSaved||(this.model.post.isPublished()||this.model.post.isScheduled())&&(e.isOverdue=this.model.get("dateDue").isBefore(ncNewLocalMoment())),this.el.innerHTML=this.template(e),this},setIsBeingSaved:function(e){this._isBeingSaved=e,this.trigger("nc:render")},_askForTaskDeletionConfirmation:function(){this._deletionStatus="awaiting-confirmation",this.trigger("nc:render")},_cancelTaskDeletion:function(){"awaiting-confirmation"===this._deletionStatus&&(this._deletionStatus="none",this.trigger("nc:render"))},_deleteTask:function(e){this._deletionStatus="deleting",this.trigger("nc:render"),this.model.destroy()},_toggleCompletion:function(){this._isBeingSaved=!0,this.trigger("nc:render");var e=this;this.model.toggleCompletionInAws(function(){e.setIsBeingSaved(!1),e.trigger("nc:render")})},_getDateFormatted:function(){if(this.model.post.isPublished()||this.model.post.isScheduled())return this.model.get("dateDue").calendar();var e;switch(this.model.get("dateType")){case"exact":return this.model.get("dateDue").calendar();case"predefined-offset":e=parseInt(this.model.get("dateValue"));break;case"negative-days":e=-parseInt(this.model.get("dateValue"));break;default:e=parseInt(this.model.get("dateValue"))}return e<0?NelioContent.i18n.dates.daysBeforePublication.replace("{days}",-e):0===e?NelioContent.i18n.dates.publicationDay:NelioContent.i18n.dates.daysAfterPublication.replace("{days}",e)},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.EditorialTasks=Backbone.View.extend({_taskViews:[],_newTaskView:!1,_rendered:!1,template:NelioContent.helpers.getTemplate("_nc-editorial-tasks"),events:{"click .nc-new-task-form-opener input":"_openNewTaskForm"},initialize:function(){"undefined"==typeof this.collection&&(this.collection=new NelioContent.collections.EditorialTasks),this.collection.each(function(e){var t=new NelioContent.views.EditorialTask({model:e});this._taskViews.push(t)},this),this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.collection,"add",this._addEditorialTask),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this._removeEditorialTask),this.listenTo(this.collection,"remove",this.render),this.listenTo(this.collection,"reset",this._resetTaskViews),this.listenTo(this.collection,"reset",this.render),this.listenTo(this.collection,"change:completed",this.render),this.listenTo(this,"nc:open:newTaskForm",this.render),this.listenTo(this,"nc:close:newTaskForm",this.render)},render:function(){if(0===this.collection.length&&(this._rendered=!1),!this._rendered){var e={taskCount:this.collection.length};this.el.innerHTML=this.template(e),this._rendered=0!==this.collection.length}var t=this.collection.where({completed:!0}),i=Math.round(100*t.length/this.collection.length),n=this.$(".nc-task-list-progress .nc-bar");100==i?n.addClass("nc-completed"):n.removeClass("nc-completed"),n.css("width",i+"%"),this.$(".nc-task-list-progress .nc-percentage").text(i+"%");var s=this.$(".nc-tasks");return s.children().detach(),_.each(this._taskViews,function(e){s.append(e.render().el)},this),this._newTaskView?(this.$(".nc-new-task-form-opener").hide(),this.$(".nc-new-task-form-container").append(this._newTaskView.render().el)):this.$(".nc-new-task-form-opener").show(),this},addEditorialTask:function(e){this._closeNewTaskForm();var t=new NelioContent.views.EditorialTask({model:e});t.setIsBeingSaved(!0),this._taskViews.push(t),this.stopListening(this.collection,"add",this._addEditorialTask),this.collection.add(e),this.listenTo(this.collection,"add",this._addEditorialTask);var i=this;e.save(void 0,{success:function(n,s){e.set(s),t.setIsBeingSaved(!1),i.trigger("nc:render")}})},_resetTaskViews:function(){_.each(this._taskViews,function(e){e.close()},this),this._taskViews=[],this.collection.each(this._addEditorialTask,this),this._sortEditorialTasks()},_addEditorialTask:function(e){var t=new NelioContent.views.EditorialTask({model:e});e.setPost(this.collection.post),this._taskViews.push(t)},_sortEditorialTasks:function(e){this._taskViews.sort(function(e,t){var i=e.model.getDateForSorting()+e.model.get("task"),n=t.model.getDateForSorting()+t.model.get("task");return i<n?-1:i>n?1:0})},_removeEditorialTask:function(e){var t=_.filter(this._taskViews,function(t){return t.model===e},this);if(t.length>0){var i=t[0];this._taskViews=_.without(this._taskViews,i),i.close()}},_openNewTaskForm:function(){this._newTaskView=new NelioContent.views.NewEditorialTask,this._newTaskView.model.setPost(this.collection.post),this.listenTo(this._newTaskView,"nc:create:task",this.addEditorialTask),this.listenTo(this._newTaskView,"nc:cancel",this._closeNewTaskForm),this.trigger("nc:open:newTaskForm")},_closeNewTaskForm:function(){this._newTaskView&&(this.stopListening(this._newTaskView),this._newTaskView.close(),this._newTaskView=!1,this.trigger("nc:close:newTaskForm"))},close:function(){_.each(this._taskViews,function(e){e.close()},this),this._taskViews=[],"function"==typeof this._newTaskView.close&&(this._newTaskView.close(),this._newTaskView=void 0),this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.NewEditorialTask=Backbone.View.extend({_assigneeView:void 0,_dueDateView:void 0,_$saveButton:void 0,template:NelioContent.helpers.getTemplate("_nc-new-editorial-task"),events:{"keyup textarea":"_updateTask","change textarea":"_updateTask","click .nc-cancel":"_cancel","click .nc-add-task:not( .button-disabled )":"_addTask","click .nc-color":"_changeColor"},initialize:function(){this.model=new NelioContent.models.EditorialTask,this._assigneeView=new NelioContent.views.UserSelector({defaultValue:this.model.get("assigneeId")}),this._dueDateView=new NelioContent.views.DateSelector({model:this.model}),this.render=_.bind(this.render,this),this.listenTo(this.model,"change:task",this._maybeEnableAddButton),this.listenTo(this.model,"change:dateType",this._maybeEnableAddButton),this.listenTo(this.model,"change:dateValue",this._maybeEnableAddButton)},render:function(){"undefined"!=typeof this._$saveButton&&this._$saveButton.tooltip("destroy");var e=this.model.toJSON();return this.el.innerHTML=this.template(e),this.$(".nc-assignee").html(this._assigneeView.render().el),this.$(".nc-date").html(this._dueDateView.render().el),this._$saveButton=this.$(".nc-add-task"),NelioContent.helpers.makeWarningTooltip(this._$saveButton),this},_cancel:function(){this.trigger("nc:cancel")},_addTask:function(){this.model.set({task:this.$("textarea").val(),assignerId:NelioContent.users.current().get("id"),assigneeId:parseInt(NelioContent.helpers.trim(this.$(".nc-assignee select").val()),10)}),this.trigger("nc:create:task",this.model)},_updateTask:function(e){this.model.set("task",NelioContent.helpers.trim(this.$("textarea").val())),13!==e.keyCode||this.model.isSomethingMissing()||this._addTask()},_maybeEnableAddButton:function(){this._$saveButton.tooltip("close");var e=this.model.isSomethingMissing();e?(this._$saveButton.addClass("button-disabled"),this._$saveButton.attr("title",e)):(this._$saveButton.removeClass("button-disabled"),this._$saveButton.attr("title",""))},_changeColor:function(t){var i=t.target||t.srcElement,n=e(i);return n.data("color")===this.model.get("color")?(n.removeClass("nc-selected"),void this.model.set("color","none")):(this.$(".nc-colors .nc-color").removeClass("nc-selected"),this.model.set("color",n.data("color")),void this.$(".nc-colors .nc-color.nc-"+this.model.get("color")).addClass("nc-selected"))},close:function(){this._assigneeView.close(),this._dueDateView.close(),this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.References=Backbone.View.extend({_rendered:!1,_views:{suggestedReferences:void 0,externalReferences:void 0},_tabTemplate:NelioContent.helpers.getTemplate("_nc-reference-tabs"),_mode:"suggested",events:{"click .nc-reference-tabs .nc-tab:not( .nc-active )":"_switchTab"},initialize:function(e){"undefined"==typeof e&&(e={}),this.suggestedReferences=e.suggestedReferences,this._views.suggestedReferences=new NelioContent.views.SuggestedReferences({collection:e.suggestedReferences}),this._views.externalReferences=new NelioContent.views.ExternalReferences({collection:e.externalReferences}),this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render)},render:function(){switch(this.$el.html(this._tabTemplate()),this.$(".nc-"+this._mode+"-references-tab").addClass("nc-active"),this._mode){case"external":this.$el.append(this._views.externalReferences.render().$el);break;default:this.$el.append(this._views.suggestedReferences.render().$el)}return this},getSuggestedReferences:function(){return this._views.suggestedReferences.collection},setExternalReferences:function(e){this._views.externalReferences.updateReferenceList(e)},_switchTab:function(e){var t=e.target||e.srcElement;t.className&&-1<t.className.indexOf("nc-external-references-tab")?this._mode="external":this._mode="suggested",this.trigger("nc:render")},close:function(){_.each(this._views,function(e){e.close()},this),this._views={},this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.SuggestedReference=Backbone.View.extend({_awaitingDiscardConfirmation:!1,_referenceEditor:void 0,template:NelioContent.helpers.getTemplate("_nc-suggested-reference"),events:{mouseleave:"_cancelDiscard","click .nc-actions .nc-edit":"_editReference","click .nc-actions .nc-discard":"_askForDiscardConfirmation","click .nc-actions .nc-cancel-discard":"_cancelDiscard","click .nc-actions .nc-do-discard":"_discard"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.model,"change",this.render)},render:function(){var e=this.model.toJSON();e.awaitingDiscardConfirmation=this._awaitingDiscardConfirmation;var t=this.model.get("suggestionAdvisorId");return e.wasSuggestedByMe=t===NelioContent.users.current().get("id"),e.wasSuggestedByNelio=0===NelioContent.users.current().get("id"),this.el.innerHTML=this.template(e),this},_editReference:function(){var e=new NelioContent.models.Reference(this.model.toJSON());this._referenceEditor=new NelioContent.views.ReferenceEditor({model:e}),this.listenTo(this._referenceEditor,"nc:update:reference",this._updateReference),this.listenTo(this._referenceEditor,"nc:close:dialog",this._closeDialog),this.trigger("nc:open:editorDialog"),this._referenceEditor.openDialog()},_updateReference:function(e){this.model.set(e)},_closeDialog:function(){this._referenceEditor.close(),this._referenceEditor=void 0,this.trigger("nc:close:editorDialog")},_askForDiscardConfirmation:function(){this._awaitingDiscardConfirmation=!0,this.trigger("nc:render")},_cancelDiscard:function(){this._awaitingDiscardConfirmation=!1,this.trigger("nc:render")},_discard:function(){this._awaitingDiscardConfirmation=!1,this.model.trigger("nc:discard",this.model)},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.SuggestedReferences=Backbone.View.extend({_urlMatcher:/^https?:\/\/([\da-z\.-]+)\.([a-z]{2,6})(\/[^\/\s]+)*\/?$/i,_referenceViews:[],template:NelioContent.helpers.getTemplate("_nc-suggested-references"),events:{"keypress input[type=url]":"_doNotPropagateEnter","keyup input[type=url]":"_onUrlChange","change input[type=url]":"_onUrlChange","click .nc-actions .button:not( .button-disabled )":"_addReference"},initialize:function(e){"undefined"==typeof this.collection&&(this.collection=new NelioContent.collections.References),this._resetReferenceViews(),this.render=_.bind(this.render,this),this.listenTo(this.collection,"add",this._resetReferenceViews),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this._resetReferenceViews),this.listenTo(this.collection,"remove",this.render),this.listenTo(this.collection,"reset",this._resetReferenceViews),this.listenTo(this.collection,"reset",this.render)},render:function(){try{this.$(".nc-actions .button").tooltip("destroy")}catch(e){}var t={amITheAuthor:this.collection.post.get("author")===NelioContent.users.current().get("id")};if(this.el.innerHTML=this.template(t),this._referenceViews.length>0){var i=this.$(".nc-list");i.empty(),_.each(this._referenceViews,function(e){i.append(e.render().el)},this)}return NelioContent.helpers.makeWarningTooltip(this.$(".nc-actions .button")),this._maybeEnableAddButton(),this.delegateEvents(),this},_resetReferenceViews:function(){_.each(this._referenceViews,function(e){e.close()},this),this._referenceViews=[],this.collection.each(function(e){var t=new NelioContent.views.SuggestedReference({model:e});this._referenceViews.push(t)},this)},_doNotPropagateEnter:function(e){13===e.keyCode&&(e.preventDefault(),e.stopPropagation())},_onUrlChange:function(e){if(this._maybeEnableAddButton()){var t=e.target||e.srcElement;this.$(t);13===e.keyCode&&this._addReference()}},_maybeEnableAddButton:function(){var e=this.$(".nc-actions .button"),t=this.$(".nc-reference-url input");return 0===NelioContent.helpers.trim(t.val()).length?(e.addClass("button-disabled"),e.attr("title",NelioContent.i18n.errors.reference.noUrl),!1):this._urlMatcher.test(NelioContent.helpers.trim(t.val()))?(e.removeClass("button-disabled"),e.attr("title",""),!0):(e.addClass("button-disabled"),e.attr("title",NelioContent.i18n.errors.reference.invalidUrl),!1)},_addReference:function(){var e=this.$("input[type=url]"),t=e.val();e.val(""),this.collection.suggestReference({id:t,url:t,urlEscaped:_.escape(t)})},close:function(){_.each(this._referenceViews,function(e){e.close()},this),this._referenceViews=[],this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.ExternalReference=Backbone.View.extend({_awaitingDiscardConfirmation:!1,_referenceEditor:void 0,template:NelioContent.helpers.getTemplate("_nc-external-reference"),events:{"click .nc-actions .nc-edit":"_editReference"},initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.model,"change",this.render)},render:function(){var e=this.model.toJSON();return e.awaitingDiscardConfirmation=this._awaitingDiscardConfirmation,this.el.innerHTML=this.template(e),this},_editReference:function(){var e=new NelioContent.models.Reference(this.model.toJSON());this._referenceEditor=new NelioContent.views.ReferenceEditor({model:e}),this.listenTo(this._referenceEditor,"nc:update:reference",this._updateReference),this.listenTo(this._referenceEditor,"nc:close:dialog",this._closeDialog),this.trigger("nc:open:editorDialog"),this._referenceEditor.openDialog()},_updateReference:function(e){this.model.set(e)},_closeDialog:function(){this._referenceEditor.close(),this._referenceEditor=void 0,this.trigger("nc:close:editorDialog")},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.ExternalReferences=Backbone.View.extend({_referenceViews:[],template:NelioContent.helpers.getTemplate("_nc-external-references"),initialize:function(e){"undefined"==typeof this.collection&&(this.collection=new NelioContent.collections.References),this._resetReferenceViews(),this.render=_.bind(this.render,this),this.updateReferenceList=_.debounce(_.bind(this.updateReferenceList,this),1200),this.listenTo(this.collection,"add",this._resetReferenceViews),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this._resetReferenceViews),this.listenTo(this.collection,"remove",this.render),this.listenTo(this.collection,"reset",this._resetReferenceViews),this.listenTo(this.collection,"reset",this.render)},render:function(){if(this.el.innerHTML=this.template(),this._referenceViews.length>0){var e=this.$(".nc-list");e.empty(),_.each(this._referenceViews,function(t){e.append(t.render().el)},this)}return this},updateReferenceList:function(e){var t=_.reject(e,_.bind(function(e){return this.collection.get(e)},this));this.collection.includeReferences(t);var i=_.filter(this.collection.pluck("id"),_.bind(function(t){return!_.contains(e,t)},this));this.collection.removeIncludedReferences(i)},_resetReferenceViews:function(){_.each(this._referenceViews,function(e){e.close()},this),this._referenceViews=[],this.collection.each(function(e){var t=new NelioContent.views.ExternalReference({model:e});this._referenceViews.push(t)},this)},close:function(){_.each(this._referenceViews,function(e){e.close()},this),this._referenceViews=[],this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.ReferenceEditor=Backbone.View.extend({_$saveButton:void 0,template:NelioContent.helpers.getTemplate("_nc-reference-editor"),events:{"change input.nc-title":"_updateTitle","keyup input.nc-title":"_updateTitle","change input.nc-url":"_updateUrl","keyup input.nc-url":"_updateUrl","change input.nc-author":"_updateAuthor","keyup input.nc-author":"_updateAuthor","change input.nc-email":"_updateEmail","keyup input.nc-email":"_updateEmail","change input.nc-twitter":"_updateTwitter","keyup input.nc-twitter":"_updateTwitter"},initialize:function(){this.render=_.bind(this.render,this),this._onDialogSave=_.bind(this._onDialogSave,this),this._onDialogCancel=_.bind(this._onDialogCancel,this),this.listenTo(this,"nc:render",this.render),this.listenTo(this.model,"change:url",this._maybeEnableSaveButton),this.listenTo(this.model,"change:twitter",this._maybeEnableSaveButton),this.listenTo(this.model,"change:email",this._maybeEnableSaveButton)},render:function(){var e=this.model.toJSON();return e.authorEscaped=_.escape(e.author),this.el.innerHTML=this.template(e),this},openDialog:function(){var e=[];this.model.get("isExternal")?e.push(NelioContent.helpers.makeDialogCancelButton(this,NelioContent.i18n.actions.cancel)):e.push(NelioContent.helpers.makeDialogCancelButton(this,NelioContent.i18n.actions.close)),e.push(NelioContent.helpers.makeDialogSaveButton(this,NelioContent.i18n.actions.save));var t=this;this.$el.dialog({title:NelioContent.i18n.titles.editReference,buttons:e,modal:!0,width:Math.min(600,NelioContent.helpers.getWindowWidth()-20),dialogClass:"nc-dialog",position:{my:"center top",at:"center top+45"},open:function(){t.listenTo(t,"nc:click:dialog:save",t._onDialogSave),t.listenTo(t,"nc:click:dialog:cancel",t._onDialogCancel),t._$saveButton=t.$el.parent().find(".button-primary"),NelioContent.helpers.makeWarningTooltip(t._$saveButton)},close:function(){t.stopListening(t,"nc:click:dialog:save",t._onDialogSave),t.stopListening(t,"nc:click:dialog:cancel",t._onDialogCancel),t._$saveButton.tooltip("destroy"),t.$el.dialog("destroy"),t.trigger("nc:close:dialog")}}),this.trigger("nc:render")},_updateTitle:function(){var e=this.$("input.nc-title").val();this.model.set("title",NelioContent.helpers.trim(e))},_updateUrl:function(){var e=this.$("input.nc-url").val();this.model.set("url",NelioContent.helpers.trim(e))},_updateAuthor:function(){var e=this.$("input.nc-author").val();this.model.set("author",NelioContent.helpers.trim(e))},_updateEmail:function(){var e=this.$("input.nc-email").val();this.model.set("email",NelioContent.helpers.trim(e))},_updateTwitter:function(){var e=this.$("input.nc-twitter").val();this.model.set("twitter",NelioContent.helpers.trim(e))},_lock:function(){this.$("input").attr("disabled","disabled")},_unlock:function(){this.model.get("isExternal")&&this.$("input").removeAttr("disabled")},_maybeEnableSaveButton:function(){this._$saveButton.tooltip("close");var e=this.model.isSomethingMissing();e?(this._$saveButton.addClass("button-disabled"),this._$saveButton.attr("title",e)):(this._$saveButton.removeClass("button-disabled"),this._$saveButton.attr("title",""))},_onDialogSave:function(){if(!this.model.isSomethingMissing()){var t=this.$el.parent(),i=t.find(".ui-dialog-titlebar button, .ui-dialog-buttonpane button:not( .button-primary )"),n=t.find(".ui-dialog-buttonpane button.button-primary");this._lock(),this.$el.dialog("option","closeOnEscape",!1),i.prop("disabled",!0),n.prop("disabled",!0),n.html(NelioContent.i18n.feedback.saving);var s=this;e.ajax({url:ajaxurl,data:{action:"nelio_content_update_reference",reference:s.model.get("postId"),title:s.model.get("title"),url:s.model.get("url"),author:s.model.get("author"),email:s.model.get("email"),twitter:s.model.get("twitter")},success:function(e){e?(s.trigger("nc:update:reference",e),s.$el.dialog("close")):this.error()},error:function(e){NelioContent.helpers.openErrorDialog(e.responseJSON),n.html(NelioContent.i18n.actions.save),i.prop("disabled",!1),n.prop("disabled",!1),s.$el.dialog("option","closeOnEscape",!0),s._unlock()}})}},_onDialogCancel:function(){this.$el.dialog("close")},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),NelioContent.views.MetaBoxError=Backbone.View.extend({template:NelioContent.helpers.getTemplate("_nc-meta-box-error"),initialize:function(){this.render=_.bind(this.render,this),this.listenTo(this.model,"change",this.render)},render:function(){var e=this.model.toJSON();return this.el.innerHTML=this.template(e),this},close:function(){this.stopListening(),this.unbind(),"undefined"!=typeof this.el&&(this.remove(),this.el=void 0,this.$el=void 0)}}),function(e){NelioContent.helpers.extractShareBlockIds=function(e){var t=_.uniq(_.flatten(_.map(e,function(e){var t=NelioContent.helpers.getShareBlockId(e);return t.length||(t=NelioContent.helpers.generateUniqueId(),e.className+=" "+t),t})));return t},NelioContent.helpers.getShareBlockId=function(e){var t=e.className,i=t.match(/ncid[0-9a-f]{8}/g);return i||(i=[]),i},NelioContent.helpers.generateUniqueId=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return"ncid"+e()+e()}}(jQuery);var n,s=e("#title"),o=e("#excerpt"),a=e("#post_author_override"),l=0<window.location.href.indexOf("nc-auto-messages=true");NelioContent.helpers.removeParamFromUrl("nc-auto-messages"),e(document).ready(function(){if(l){var t=document.getElementById("nelio-content-social-timeline-container");t&&setTimeout(function(){t=t.getBoundingClientRect(),e("body, html").animate({scrollTop:Math.max(window.scrollY+t.top-60,0)})},3e3)}});var r=!1;e(document).on("tinymce-editor-init",function(t,i){r=i,e(document).trigger("nc:tinymce-editor",r)}),e.ajax({url:ajaxurl,data:{action:"nelio_content_get_post",post:e("#post_ID").val()},success:function(e){n=new NelioContent.models.Post(e)},error:function(){n=new NelioContent.models.Post({id:parseInt(e("#post_ID").val(),10),title:NelioContent.helpers.decodeHTMLEntities(s.val()),excerpt:NelioContent.helpers.decodeHTMLEntities(o.text()),permalink:e("#sample-permalink a").attr("href"),author:parseInt(e("#post_author").val(),10),status:"auto-draft"})},complete:function(){n.set("imageId",parseInt(e("#nc-feat-image-thumbnail-id").val(),10)),n.set("image",e("#nc-feat-image-url").val()),n.set("autoImage",e("#nc-feat-image-auto-url").val()),t(n),i(n)}});var c,h,d,u;c=new NelioContent.views.SocialTimeline,window.NCTinyMce=window.NCTinyMce||{},NCTinyMce.timelineView=c,d=new NelioContent.views.EditorialTasks,h=new NelioContent.views.EditorialComments}(jQuery);